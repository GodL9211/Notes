# 集群

Redis常见的集群方案：，，，

## 主从架构

主从架构由一个Redis实例作为master，多个Redis实例作为slave（又称为replica）。

- master负责处理用户的写请求，slave负责处理用户的读请求，并同步master的数据。
- 通常将slave设置成只读权限。
- slave在同步数据时，不能响应用户的读请求。

### 部署

部署时，只需在slave的配置文件中加上master的信息，如下：

    slaveof 10.0.0.1 6379          # 设置master
    masterauth vLbs6jnrbxMv7lUa    # master的密码
    replica-read-only yes          # slave只允许读操作

用这样的配置文件启动slave之后，进入Redis的终端，执行`info Replication`可查看主从服务器的信息。

### 哨兵

哨兵（Sentinel）：Redis官方提供的一个分布式监控系统，用于提高Redis的可用性。

- 在每个Redis服务器的主机上运行一个哨兵进程，监控Redis的状态。
- 如果哨兵判断master挂掉了，就自动选出一个slave作为新的master。该救援过程称为failover。
- 选出新master的过程中，需要有一个slave得到超过半数的哨兵投票，否则开始下一轮投票。
- 哨兵默认使用的端口是26379。
- 哨兵系统应该至少部署三个哨兵实例，并且部署在三个独立的主机上。如果启动的哨兵数过少，就可能达不到同意救援的哨兵数。

执行`vim /etc/redis/sentinel.conf`编辑哨兵的配置文件，例如：

    protected-mode no   # 相当于bind 0.0.0.0
    port 26379
    daemonize yes
    dir /etc/redis/
    logfile /var/log/redis-sentinel.log
    pidfile /var/run/redis-sentinel.pid

    sentinel monitor master1 10.0.0.1 6379 2  # 监控的master
    sentinel auth-pass master1 ******  # master的密码
    sentinel down-after-milliseconds master1 1000     # 哨兵不能连接到master超过多久时（单位ms），就判断master挂掉了
    sentinel parallel-syncs master1 1   # 选出新master之后，同时安排多少个slave与它开始同步
    sentinel failover-timeout master1 10000    # 救援过程的超时时间（单位ms），超过该时间之后就认为救援失败
    sentinel deny-scripts-reconfig yes  # 不允许在Redis终端用SENTINEL SET进行配置

- sentinel monitor的最后一个字段称为quorum，表示至少有多少个哨兵认为master挂掉了，就由其中一个哨兵开始救援。
- 哨兵在运行时会根据情况自动重写自己的配置文件，以及各个Redis实例的配置文件。
  - 它会自动检测出其它slave和哨兵，作为known-replica、known-sentinel记在配置文件中。
  - 如果设置了master的密码，当哨兵选出一个新master时，会把它的密码设置成原master的密码。
- 执行`redis-server /etc/redis/sentinel.conf --sentinel`启动哨兵。
- 执行`redis-cli -p 26379 info Sentinel`可查看哨兵的信息。

例：

部署一主二从集群，并在它们三个主机上分别部署哨兵。
终止master，可看到哨兵的日志如下：

    202:X 18 Nov 2019 17:02:12.468 # +sdown master master1 10.244.79.33 6379    # 检测到master可能挂掉
    202:X 18 Nov 2019 17:02:12.583 # +new-epoch 12    # 开始一次投票周期
    202:X 18 Nov 2019 17:02:12.590 # +vote-for-leader 4f648158ea1a5f8df03b001396042d18cef56367 12
    202:X 18 Nov 2019 17:02:13.547 # +odown master master1 10.244.79.33 6379 #quorum 3/2    # 有3个哨兵认为master挂掉，决定开始救援
    202:X 18 Nov 2019 17:02:13.644 # +switch-master master1 10.244.79.33 6379 10.244.53.62 6379    # 将master从*.33节点改为*.62节点
    202:X 18 Nov 2019 17:02:13.645 * +slave slave 10.244.25.157:6379 10.244.25.157 6379 @ master1 10.244.53.62 6379     # 更新该节点的master
    263:X 18 Nov 2019 17:02:16.355 * +slave slave 10.244.79.33:6379 10.244.79.33 6379 @ master1 10.244.53.62 6379    # 更新该节点的master

如果failover失败，哨兵会不停地发起新投票（new-epoch），如下：

    503:X 18 Nov 2019 15:55:18.755 # +new-epoch 21
    503:X 18 Nov 2019 15:55:18.755 # +try-failover master master1 10.244.79.33 6379
    503:X 18 Nov 2019 15:55:18.762 # +vote-for-leader 91ad63983edf9cfc378b2a37491c5621ebfceff5 21
    503:X 18 Nov 2019 15:55:18.776 # dc54b5f06544c8bf830b9f8b00f199b96e0e6b16 voted for 91ad63983edf9cfc378b2a37491c5621ebfceff5 21
    503:X 18 Nov 2019 15:55:18.778 # d2ceda111b29ad5f6e3932864fb2b7ca8e2309ff voted for 91ad63983edf9cfc378b2a37491c5621ebfceff5 21
    503:X 18 Nov 2019 15:55:18.817 # +elected-leader master master1 10.244.79.33 6379
    503:X 18 Nov 2019 15:55:18.818 # +failover-state-select-slave master master1 10.244.79.33 6379
    503:X 18 Nov 2019 15:55:18.894 # -failover-abort-no-good-slave master master1 10.244.79.33 6379
    503:X 18 Nov 2019 15:55:18.995 # Next failover delay: I will not start a failover before Mon Nov 18 15:55:39 2019

- 上方，failover-abort-no-good-slave表示没有找到合适的slave来担任master，原因可能是：
  - 哨兵不能连接到slave
  - slave设置了密码

