# 性能优化

## 服务器状态

- 在 shell 中，可以用 mongostat、mongostop 命令查看 MongoDB 服务器的运行状态。
- 在 mongo 客户端中，可以用以下命令查看服务器的状态：
  ```js
  db.serverStatus()               // 查看服务器的状态信息
  db.serverStatus().connections   // 查看客户端连接数
  db.serverStatus().tcmalloc.tcmalloc.formattedString // 查看各种用途的内存大小

  db.currentOp()                  // 查看数据库正在执行的所有操作
  db.currentOp({op: "query", active: true}) // 查看 query 类型的活跃操作
  db.currentOp(<opid>)            // 终止一个操作
  ```

## explain

- 在 mongo 客户端执行某个操作时，可加上 explain() 方法，显示统计信息。
- explain() 有多种工作模式：
  ```js
  queryPlanner        // 显示当前操作的执行计划，不会实际执行操作
  executionStats      // 执行当前操作，然后显示统计信息
  allPlansExecution   // 先显示执行计划，然后执行当前操作、显示统计信息
  ```
- 可通过以下格式调用 explain() 方法：
  ```js
  db.<collection>.<method>.explain()    // 默认采用 queryPlanner 模式
  db.<collection>.explain().<method>
  ```
  例：
  ```js
  > db.books.find({"group": "art"}).explain('allPlansExecution')
  {
      "queryPlanner": {
          "plannerVersion": 1,
          "namespace": "test.books",      // 当前位于的 db.collection
          "indexFilterSet": false,
          "parsedQuery": {                // 将查询语句解析成基础指令
              "group": {
                  "$eq": "art"
              }
          },
          "winningPlan": {                // 准备了多个执行计划，从中选出效率最高的一个计划来执行，其它计划记录到 rejectedPlans 字段
              "stage": "FETCH",           // FETCH 表示先查询索引，然后据此读取集合中的文档。而 COLLSCAN 表示全表扫描，不使用索引
              "inputStage": {
                  "stage": "IXSCAN",
                  "keyPattern": {
                      "group": 1
                  },
                  "indexName": "group_1", // 使用的索引名
                  ...
              }
          },
          "rejectedPlans": []
      },
      "executionStats": {
          "executionSuccess": true,       // 操作是否执行成功
          "nReturned": 829330,            // 返回的文档数
          "executionTimeMillis": 4825,    // 操作的执行耗时
          "totalKeysExamined": 829330,    // 在索引中读取了多少条目。如果为 0 ，说明没有使用索引，或在索引中没有查询到匹配的文档
          "totalDocsExamined": 829330,    // 在集合中读取了多少文档。这里 totalDocsExamined 等于 nReturned ，说明成功用索引提高了查询效率，没有读取无关的文档
          "executionStages": {
              ...
          },
          "allPlansExecution": []
      },
      "serverInfo": {
          "host": "c442af87b30b",
          "port": 27017,
          "version": "4.4.17",
          "gitVersion": "85de0cc83f4dc64dbbac7fe028a4866228c1b5d1"
      },
      "ok": 1
  }
  ```
