# 性能优化

## 查看服务器

- 在 shell 中，可以用 mongostat、mongostop 命令查看 MongoDB 服务器的运行状态。
- 在 mongo 客户端中，可以用以下命令查看服务器的状态：
  ```js
  db.serverStatus()               // 查看服务器的状态信息
  db.serverStatus().connections   // 查看客户端连接数

  db.currentOp()                  // 查看数据库正在执行的所有操作
  db.currentOp({op: "query", active: true}) // 查看 query 类型的活跃操作
  db.currentOp(<opid>)            // 终止一个操作
  ```

- 例：查看服务器的内存开销
  ```js
  > db.serverStatus().tcmalloc.tcmalloc.formattedString
  ------------------------------------------------
  MALLOC:    29943407472 (28556.3 MiB) Bytes in use by application        // mongod 进程正在使用的内存，可能用于存放文档、索引等数据
  MALLOC: +   6028980224 ( 5749.7 MiB) Bytes in page heap freelist        // 堆内存中的空闲空间，尚未被 tcmalloc 内存分配器释放给操作系统
  MALLOC: +   1164940264 ( 1111.0 MiB) Bytes in central cache freelist
  MALLOC: +            0 (    0.0 MiB) Bytes in transfer cache freelist   // transfer cache 用于在 central cache 与 thread cache 之间传输数据
  MALLOC: +    788441256 (  751.9 MiB) Bytes in thread cache freelists
  MALLOC: +    220553472 (  210.3 MiB) Bytes in malloc metadata
  MALLOC:   ------------
  MALLOC: =  38146322688 (36379.2 MiB) Actual memory used (physical + swap) // mongod 进程在操作系统中占用的内存，等于上面几项内存之和
  MALLOC: +   1304309760 ( 1243.9 MiB) Bytes released to OS (aka unmapped)
  MALLOC:   ------------
  MALLOC: =  39450632448 (37623.1 MiB) Virtual address space used
  MALLOC:
  MALLOC:        2613472              Spans in use
  MALLOC:           4708              Thread heaps in use
  MALLOC:           4096              Tcmalloc page size
  ```

- 查看存储体积：
  ```js
  db.stats().dataSize       // 数据库的数据体积，包括文档、索引，单位 bytes 。这是读取到内存时的体积，也是 mongodump 不压缩时的体积
  db.stats().storageSize    // 数据库占用的磁盘空间。可能比 dataSize 小，因为 WiredTiger 存储引擎默认进行压缩。也可能比 dataSize 大，因为删除的文档不会释放磁盘空间

  db.<collection>.stats().size        // 集合的数据体积
  db.<collection>.stats().storageSize // 集合占用的磁盘空间

  db.<collection>.stats().wiredTiger["block-manager"]["file size in bytes"]             // 集合占用的磁盘空间
  db.<collection>.stats().wiredTiger["block-manager"]["file bytes available for reuse"] // 集合占用的磁盘空间中，标记为 deleted 的空间
  db.<collection>.stats().wiredTiger["cache"]["bytes currently in the cache"]           // 集合占用的内存体积，包括 dirty pages 和 clean pages
  db.<collection>.stats().wiredTiger["cache"]["bytes read into cache"]                  // 累计从磁盘读取到内存的数据体积
  db.<collection>.stats().wiredTiger["cache"]["bytes written from cache"]               // 累计从内存写入磁盘的数据体积
  db.<collection>.stats().wiredTiger["cache"]["tracked dirty bytes in the cache"]       // 内存中的脏页数
  db.serverStatus().wiredTiger["cache"]["bytes currently in the cache"] /1024/1024/1024 // 整个 wiredTiger 占用的内存体积
  ```

## explain

- 在 mongo 客户端执行命令时，可加上 explain() 方法，显示统计信息。
- explain() 有多种工作模式：
  ```js
  queryPlanner        // 显示当前操作的执行计划，不会实际执行操作
  executionStats      // 执行当前操作，然后显示统计信息
  allPlansExecution   // 先显示执行计划，然后执行当前操作、显示统计信息
  ```
- 可通过以下格式调用 explain() 方法：
  ```js
  db.<collection>.<method>.explain()    // 默认采用 queryPlanner 模式
  db.<collection>.explain().<method>
  ```
  例：
  ```js
  > db.books.find({"group": "art"}).explain('allPlansExecution')
  {
      "queryPlanner": {
          "plannerVersion": 1,
          "namespace": "test.books",      // 当前位于的 db.collection
          "indexFilterSet": false,
          "parsedQuery": {                // 将查询语句解析成基础指令
              "group": {
                  "$eq": "art"
              }
          },
          "winningPlan": {                // 准备了多个执行计划，从中选出效率最高的一个计划来执行，其它计划记录到 rejectedPlans 字段
              "stage": "FETCH",           // FETCH 表示先查询索引，然后据此读取集合中的文档。而 COLLSCAN 表示全表扫描，不使用索引
              "inputStage": {
                  "stage": "IXSCAN",
                  "keyPattern": {
                      "group": 1
                  },
                  "indexName": "group_1", // 使用的索引名
                  ...
              }
          },
          "rejectedPlans": []
      },
      "executionStats": {
          "executionSuccess": true,       // 操作是否执行成功
          "nReturned": 829330,            // 返回的文档数
          "executionTimeMillis": 4825,    // 操作的执行耗时
          "totalKeysExamined": 829330,    // 在索引中读取了多少条目。如果为 0 ，说明没有使用索引，或在索引中没有查询到匹配的文档
          "totalDocsExamined": 829330,    // 在集合中读取了多少文档。这里 totalDocsExamined 等于 nReturned ，说明成功用索引提高了查询效率，没有读取无关的文档
          "executionStages": {
              ...
          },
          "allPlansExecution": []
      },
      "serverInfo": {
          "host": "c442af87b30b",
          "port": 27017,
          "version": "4.4.17",
          "gitVersion": "85de0cc83f4dc64dbbac7fe028a4866228c1b5d1"
      },
      "ok": 1
  }
  ```
