# 查询

## 简单查询

- ES 支持通过 GET 请求进行简单查询。
  - 相关 API ：
    ```sh
    GET /<index>/_doc/_search   # 查询指定索引下的文档
    GET /<index>/_search        # 可以省略 _doc/
    GET /_search                # 查询所有索引下的文档

    GET /_search?q=name:Leo     # 可以在 URL 的查询字符串中加入 q 字段及查询参数
    ```

- 对 ES 发出查询请求之后，收到的响应内容格式如下：
  ```sh
  [root@Centos ~]# curl -X GET 127.0.0.1:9200/student/_search?pretty
  {
    "took" : 14,                  # 本次查询的耗时，单位为 ms
    "timed_out" : false,          # 该请求的处理过程是否超时
    "_shards" : {
      "total" : 1,                # 总共查询了多少个分片
      "successful" : 1,           # 有多少个分片成功了
      "skipped" : 0,              # 有多少个分片跳过了
      "failed" : 0                # 有多少个分片失败了
    },
    "hits" : {
      "total" : {
        "value" : 8,              # 总共找到了多少个与查询条件相匹配的文档
        "relation" : "eq"         # 这些文档与查询条件的关系
      },
      "max_score" : 1.0,          # 这些文档的最大相关性
      "hits" : [                  # hits 字典中的 hits 数组包含了 ES 实际返回给客户端的文档。查询条件可能匹配任意个文档，但默认最多返回 10 个
        {
          "_index" : "student",
          "_type" : "_doc",
          "_id" : "ZhzMiXABzduhqPWX7mUX",
          "_score" : 1.0,         # 一个正浮点数，表示该文档与查询条件的相关性
          "_source" : {
            "name" : "Leo",
            "age" : 10,
            "interests" : [
              "sports",
              "music"
            ]
          }
        },
        ...
  ```
  - ES 默认将 hits 数组中的各个文档按 _score 的值进行排序。

## DSL 查询

- ES 提供了一种 DSL 查询语法，可以实现复杂的查询。
  - 它需要在请求报文 body 中加入 JSON 格式的查询参数。
  - 相关 API ：
    ```sh
    GET /<index>/_search           [request_body]
    GET /_search                   [request_body]

    GET /<index>/_delete_by_query  [request_body]   # 删除与 DSL 查询条件匹配的文档
    ```
    - 可以使用 GET 或 POST 方法。
    - 如果省略 request_body ，则会匹配所有文档，相当于简单查询。

### match

：用于查询字段的值等于指定值的文档。
- 例：
  ```sh
  GET /student/_search
  {
    "query" : {
      "match" : {
        "name" : {          # 要查询的字段
          "query" : "Leo"   # 查询字段的值等于它的文档
          # "fuzziness": 0,
          # "max_expansions": 50,
        }
      }
    }
  }
  ```
  - 没有其它查询参数时，可以简写为：
    ```sh
    "match" : {
      "name" : "Leo"
    }
    ``
  - 查询的字段可以是以下形式：
    ```sh
    "age" : 10      # 字段的值可以是 string、number、boolean 等类型
    "age" : "10"    # number 类型的值也可以写作 string 形式

    "host.os.platform" : "centos"   # 字段名可以通过 . 引用子字段
    ```
  - match 子句有以下几种：
    ```sh
    "match"        : { "name" : "A B" }    # 匹配 name 等于 A 或 B 的文档
    "match_phrase" : { "name" : "A B" }    # 匹配 name 等于 "A B" 的文档
    "match_all"    : { }                   # 匹配索引文档
    ```

### term

：用于进行精确查询。
- 例：
  ```sh
  GET /_search
  {
    "query": {
      "term": {
        "name": {
          "value": "Leo"    # 字段值必须等于它
          # "boost": 1.0,   # 控制相关性分数 _score 。默认取值为 1.0 ，取值小于 1 会降低得分，取值大于 1 会增加得分
        }
      }
    }
  }
  ```
- ES 会将 text 类型的字段进行优化，比如删除标点符号、分词。因此用 term 查询时会不匹配，应该用 match 查询。

### exists

：用于查询存在指定字段的文档。
- 例：
  ```sh
  GET /_search
  {
    "query": {
      "exists": {
        "field": "name"
      }
    }
  }
  ```

### range

：用于查询字段值在指定范围内的文档。
- 例：
  ```sh
  GET /_search
  {
    "range" : {
      "age" : {
        "gt" : 10,        # 大于
        "lt" : 20,        # 小于
        # "gte" : 20,     # 大于等于
        # "lte" : 20,     # 小于等于
      }
    }
  }
  ```

### prefix

：用于进行前缀查询。
- 只能查询 text、keyword 类型的字段。
- 例：
  ```sh
  GET /_search
  {
    "query": {
      "prefix": {
        "name": {
          "value": "Leo"  # 字段值需要以该前缀开头
        }
      }
    }
  }
  ```

### wildcard

：用于进行通配符查询。
- 可以使用以下通配符：
  - `?` ：匹配单个任何字符。
  - `*` ：匹配任意个字符，包括零个。
- 例：
  ```sh
  GET /_search
  {
    "query": {
      "wildcard": {
        "name": {
          "value": "Leo*"   # 字段值需要匹配该 pattern
        }
      }
    }
  }
  ```
  - 用于查询的 pattern 应该尽量避免以通配符开头，否则会大幅增加查询的开销。

### regexp

：用于进行正则查询。
- 例：
  ```sh
  GET /_search
  {
    "query": {
      "regexp": {
        "name": {
          "value": "Leo.*"  # 字段值需要匹配该正则表达式
        }
      }
    }
  }
  ```

### fuzzy

：用于进行模糊查询。
- 模糊查询时，会将查询的值修改几个字符，生成一些变体，然后分别尝试 match 查询。
  - 修改的字符数称为编辑距离。
  - 每个字符区分大小写。
  - 比如编辑距离为 1 时， "Leo" 可以生成以下变体：
    ```sh
    leo     # 替换一个字符
    Le      # 移除一个字符
    Lego    # 在任意位置插入一个字符
    Loe     # 交换两个相邻字符的位置
    ```
- 例：
  ```sh
  GET /_search
  {
    "query": {
      "fuzzy": {
        "name": {
          "value": "Leo"          # 字段值需要与它模糊匹配
          # "fuzziness": "AUTO",  # 允许的最大编辑距离
          # "max_expansions": 50, # 允许的最大变体数
        }
      }
    }
  }
  ```

### sort

：用于控制文档的排序。
- 例：
  ```sh
  GET /_search
  {
    "query": {
      "match_all": {}   # 匹配所有文档
    },
    "sort": [{          # 查询结果按 age 的值升序排列
      "age": "asc"
    }],
    "from": 5,          # 返回从编号 5 开始的文档（从 0 开始编号）
    "size": 2           # 最多返回 2 个文档
  }
  ```

### filter

：用于添加过滤器，使 ES 只返回过滤后的文档。
- 例：
  ```sh
  GET /_search
  {
    "query": {
      "bool": {
        "must": {
          "match_all": {}
        },
        "filter": {
          "match": {
            "name": "Leo"
          }
        }
      }
    }
  }
  ```
  - `query` 参数中的查询子句称为“查询上下文”，`filter` 参数中的查询子句称为 “过滤器上下文” 。
  - ES 只会返回同时匹配 “查询上下文” 和 “过滤器上下文” 的文档，不过文档的 _score 的值只由 “查询上下文” 决定，不受 “过滤器上下文” 影响。

### bool

：用于进行布尔查询。
- 例：
  ```sh
  GET /_search
  {
    "query": {
      "bool": {
        "must": [{
            "range": {
              "age": {
                "gte": 10,
                "lte": 20
              }
            }
          },
          {
            "bool": {
              "should": [{
                  "match": {
                    "name": "A"
                  }
                },
                {
                  "match": {
                    "name": "B"
                  }
                }
              ],
              "minimum_should_match": 1
            }
          }
        ],
        "must_not": [{
          "match": {
            "age": "12"
          }
        }]
      }
    }
  }
  ```
  - match、exists、wildcard 等查询子句一次只能查询一个字段，查询多个字段时需要通过 bool 查询组合起来。
  - bool 查询中可以组合使用以下查询子句：
    - `must` 子句是一个数组，文档必须符合其中列出的所有条件。
    - `must_not` 子句是一个数组，文档必须不符合其中列出的所有条件。
    - `should` 子句是一个数组，文档应该符合其中列出的条件。不能写在与 must 同一层级的位置，否则会失效。
    - `filter` 子句
  - `minimum_should_match` 表示文档至少应该符合 `should` 数组中的几个条件。
    - 默认值为 1 。
    - 可以设置成任意正整数，比如 10 。不过实际生效的值不会超过 `should` 条件总数 n 。
    - 可以设置成任意负整数，比如 -2 ，这表示实际生效的值等于 n-2 。
    - 可以设置成百分比格式，比如 75% 、-25% ，这会向下取整。


## 聚合

> TODO:待补充


