# ElasticSearch

：简称为 ES ，一个搜索引擎，也可用作存储 JSON 格式数据的 NoSQL 数据库。
- [官方文档](https://www.elastic.co/guide/en/elasticsearch/reference/7.6/index.html)
- 基于 Java 开发，基于 Lucene 实现。
- 采用 C/S 架构、TCP 通信。

## 版本

- v1.0 ：于 2010 年发布。最初由 Shay Banon 开发，后来由 Elastic 公司管理。
- v6.0 ：于 2017 年发布。
- v7.0 ：于 2019 年发布。

## 原理

- ES 允许用户写入数据，并进行搜索。
  - 每条数据称为一个文档（document），采用 JSON 格式，可以包含多个字段（field）。
  - 容纳文档的集合称为索引（index）。

- 使用 ES 的一般流程：
  1. 在 ES 中创建索引，定义文档的数据结构。
  2. 向索引中写入一些文档。
  3. 向索引中搜索一些文档。

- ES 的每个索引由一个或多个分片（shard）组成。
  - 索引下新增的文档会平均分配到各个分片中，而分片可以存储在不同 ES 节点上。
    - 客户端发出查询请求时，不必知道文档存储在哪个分片、分片存储在哪个节，因为 ES 会自动完成查询。
  - 在 ES 索引中进行查询时，是先在它的每个分片中进行查询，然后合并它们的查询结果。
    - ES 会给每个分片创建一个线程进行查询。因此划分多个分片可以并行查询，但分片数过多也会增加查询耗时。
    - 对于单个分片，体积过大则会增加查询耗时、故障后恢复耗时，体积过小则会增加冗余量。
      - 建议单个分片的体积控制在 10~40G ，比如每天创建一个新索引用于存储数据。

### Lucene

：一个搜索引擎，基于 Java 开发。
- 于 2000 年开源，由 ASF 管理。
- Lucene 将存储的每条数据称为文档（document），容纳文档的集合称为索引（index）。
  - 每个索引由一个或多个子索引组成。
- 子索引（sub-index）又称为索引段（index segment）。
  - 每个索引段中可以写入多个文档，并给它们分配在该索引段中唯一的 DocId 。
  - 每个索引段会单独建立索引，因此可以单独在其中搜素。
    - 在 Lucene 索引中进行查询时，是先依次在它的每个索引段中进行查询，然后合并它们的查询结果。
  - 当客户端请求新增文档时，Lucene 会将文档写入内存缓冲区，然后返回响应给客户端。
    - 每隔一定时间，Lucene 会将内存缓冲区中的文档保存为一个新的索引段。该过程称为 Commit 。
      - 在 Lucene Commit 之前，内存缓冲区中写入的文档不能被客户端查询到，并且会在 Lucene 异常终止时丢失。
  - 索引段不支持修改。
    - 当客户端请求删除文档时，Lucene 只是将文档标记为 deleted ，但并不会改变磁盘上存储的索引段。（除非删除整个索引）
    - 当客户端请求查询文档时，Lucene 会依次在每个索引段中进行查询，依然会查询标记为 deleted 的文档，只是在返回查询结果时排除掉。（导致查询耗时增加）
    - 当客户端请求修改文档时，Lucene 会先删除原文档，再创建一个新文档。（导致开销比新增文档更大）

#### ES 与 Lucene

- ES 的每个分片是基于一个 Lucene 索引实现的。
- ES 对 Lucene 新增文档的流程做了改进，如下：
  1. 将新增的文档写入内存缓冲区（buffer），并备份到事务日志（translog）中。
      - 如果 ES 异常终止，则重启后会从 translog 中恢复未提交的数据。
      - 对 translog 文件的修改是存储在内存 dirty page 中，如果系统宕机，则 translog 中的数据依然会丢失。
      - ES 默认每隔 5s 调用一次操作系统的 fsync ，将内存 dirty page 中的文件写入磁盘。
  2. 当 buffer 满了，或者默认每隔 1s ，ES 会将 buffer 中的文档保存为一个新的索引段，然后清空 buffer 。该过程称为 Refresh 。
      - 此时，该索引段文件也是存储在内存 dirty page 中，没有实际写入磁盘。但可以被打开读取，可以查询其中的文档。
      - 如果 Refresh 的频率过高，则会产生大量体积小的索引段。
      - 一次性新增大量文档时，建议暂时停止 ES 的自动刷新，以减少耗时。
  3. 重复 1、2 步骤，继续新增文档，使得 translog 文件越来越大。
  4. 如果 translog 文件超过一定大小，ES 就会执行一次 fsync ，然后创建一个新的 translog 文件供写入。该过程称为 Flush 。
      - 如果 Flush 的频率过高，则会增加等待磁盘 IO 的耗时。

- ES 会定期将较小的索引段合并成较大的索引段。
  - 合并时，会排除标记为 deleted 的文档。
  - 合并时，对索引的影响很大，建议先停止写入。
  - 默认超过 5G 的索引段不会被自动合并，但可以被 forcemerge 。

## 客户端

- ES 服务器提供了 Restful API 供客户端访问。
- 客户端向 ES 服务器发出请求的标准格式如下：
  ```sh
  [root@Centos ~]# curl -X GET 127.0.0.1:9200/_count?pretty -H 'content-Type:application/json' -d '
  > {
  >   "query": {
  >     "match_all": {}
  >   }
  > }'
  {
    "count" : 1,
    "_shards" : {
      "total" : 1,
      "successful" : 1,
      "skipped" : 0,
      "failed" : 0
    }
  }
  ```
  - curl 命令加上 `-H 'content-Type:application/json'` 之后，便可以发送 JSON 格式的查询参数。
  - 如果客户端发出的请求报文 body 不能按 JSON 格式正常解析，ES 就会返回 HTTP 400 报错。
  - ES 返回的响应报文 body 是 JSON 格式的字符串。
    - 如果在请求 URL 末尾加上 `?pretty` ，则会让 ES 返回经过缩进、换行的 JSON 字符串。
- 为了方便书写，下文将客户端的请求简记成如下格式：
  ```json
  GET /_count
  {
    "query": {
      "match_all": {}
    }
  }
  ```

## 相关概念

- Solr
  - ：一个基于 Lucene 的搜索引擎，基于 Java 开发。
  - 于 2006 年开源，由 ASF 管理。
  - 基于 zookeeper 运行分布式系统。
  - Solr 比 ES 的功能更丰富，但 ES 的实时性更强。

- 正排索引
  - 当用户搜索一个字符串时，搜索引擎会逐个查询已有的文档，找出包含该字符串的所有文档。\
    然后建立索引：某个字符串，对应某个文档。
  - 这样建立索引的过程简单，但搜索速度慢。

- 倒排索引
  - 事先建立索引：某个单词，对应某个文档的某个位置。\
    当用户搜索一个字符串时，先将它拆分成多个单词，然后根据索引定位文档。
  - 这样建立索引的过程复杂，但搜索速度快。
  - ES 等大部分搜索引擎都支持倒排索引，以大幅提高全文搜索的速度。
