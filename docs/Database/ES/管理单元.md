# 管理单元

ES 的管理单元从上到下依次分为：
- `index`
  - ：索引，相当于 MySQL 的数据库（与 MySQL 的索引是不同概念）。
  - ES 中可以创建多个 index 。
  - index 名不能包含大写字母，不能以下划线开头。

- `type`
  - ：映射类型，相当于 MySQL 的数据表。
  - 每个 type 中可以存储多个文档。
  - 官方计划取消 type 的设定：
    - ES 6.0 版本开始，每个 index 中只能创建一个 type ，默认命名为 _doc 。
    - ES 7.0 版本开始，不推荐使用 type 。
    - ES 8.0 版本开始，禁用 type 。

- `document`
  - ：文档，相当于 MySQL 的数据行。
  - 每个文档是一个 JSON 格式的文本。
  - 新增文档的过程又称为“索引文档”。
  - ES 默认会对文档的每个字段建立倒排索引，因此支持全文搜索。

## index

### 查

- 相关 API ：
  ```sh
  HEAD  /<index>                  # 检查索引是否存在。如果查询的所有索引都存在，则返回 HTTP 200 ，否则返回 HTTP 404
  GET   /<index>                  # 查询索引的信息，包括 aliases、mappings、settings
  GET   /<index>/_settings        # 查询索引的配置
  GET   /<index>/_mappings        # 查询索引的数据结构
  GET   /<index>/_stats           # 查询索引的统计信息

  GET   /_resolve/index/<name>    # 解析一个名称，返回与之匹配的所有的 indices、aliases、data_streams
  ```
  - `<index>` 可以填入以下形式的值：
    ```sh
    my-index-1                      # 一个索引名
    my-index-1,my-index-2           # 多个索引名，用逗号分隔
    my-index-*                      # 可以使用通配符 * 匹配多个索引名
    ```

### 增

- 相关 API ：
  ```sh
  PUT   /<index>  [request_body]    # 创建索引，可以在 request_body 中加上配置信息，如果不加则使用索引模板的默认配置
  ```
- 例：直接创建索引
  ```sh
  [root@Centos ~]# curl -X PUT 127.0.0.1:9200/class?pretty
  {
    "acknowledged" : true,          # 表示操作成功
    "shards_acknowledged" : true,   # 表示已经启动分片
    "index" : "class"               # 索引名
  }
  ```
  - 如果请求创建的索引已存在，则会返回 HTTP 400 。

- 例：在创建索引时加上配置信息
  ```sh
  PUT /my-index-1
  {
    "settings": {
      "index": {
        # "codec": "best_compression",  # 索引段的压缩率，默认为 LZ4 。更高的压缩率会减少占用的磁盘空间，但是增加读写文档的耗时
        "number_of_shards": 3,          # 主分片的数量，默认为 1
        "number_of_replicas": 2,        # 每个主分片的副本数量，默认为 1
        "refresh_interval" : "5s",      # 每隔一定时间自动刷新一次索引。默认为 1 s ，接近实时搜索。设置成 -1 则不自动刷新
        "max_result_window": "10000",   # 限制单个请求搜索文档的最大数量
      }
    }
  }
  ```

### 改

- 相关 API ：
  ```sh
  PUT   /<index>/_settings  <request_body>  # 修改索引的配置
  POST  /<index>/_clone/<target-index>      # 将一个索引拷贝为一个新索引
  ```

- 可以将索引关闭，禁止读、写操作。适合在不删除索引的情况下减少 ES 对该索引的开销。如下：
  ```sh
  POST  /<index>/_close   # 关闭索引
  POST  /<index>/_open    # 打开已关闭的索引
  ```

### 删

- 相关 API ：
  ```sh
  DELETE /<index>         # 删除索引。如果该索引不存在，则会返回 HTTP 404
  ```

## document

### 查

- 相关 API ：
  ```sh
  GET   /<index>/_doc/<_id>   # 查询指定 _id 的文档的内容
  HEAD  /<index>/_doc/<_id>   # 查询指定 _id 的文档是否存在

  GET   /_count               # 查询所有索引包含的文档数
  GET   /<index>/_count       # 查询指定索引包含的文档数
  ```

- 例：查询文档
  ```sh
  [root@Centos ~]# curl -X GET 127.0.0.1:9200/student/_doc/1?pretty
  {
    "_index" : "student",
    "_type" : "_doc",
    "_id" : "1",
    "_version" : 9,
    "_seq_no" : 17,
    "_primary_term" : 1,
    "found" : true,       # 表示成功找到了该文档
    "_source" : {
      "name" : "Leo",
      "age" : 10,
      "interests" : [
        "sports",
        "music"
      ]
    }
  }
  ```

### 增

- 相关 API ：
  ```sh
  POST   /<index>/_doc        <request_body>    # 新增文档
  POST  /<index>/_doc/<_id>   <request_body>    # 修改指定 _id 的文档的内容
  ```

- 例：新增文档
  ```sh
  [root@Centos ~]# curl -X POST 127.0.0.1:9200/student/_doc?pretty -H 'content-Type:application/json' -d '
  > {
  >   "name" : "Leo",
  >   "age" : 10,
  >   "interests": [ "sports", "music" ]
  > }'
  {
    "_index" : "student",
    "_type" : "_doc",
    "_id" : "ZhzMiXABzduhqPWX7mUX",
    "_version" : 1,
    "result" : "created",             # 表示成功创建了该文档
    "_shards" : {
      "total" : 2,
      "successful" : 1,
      "failed" : 0
    },
    "_seq_no" : 0,
    "_primary_term" : 1
  }
  ```
  - 这里是以 `/$index_name/$type_name` 作为 HTTP 请求的目标 URL 。
  - 新增文档时，如果对应的 index 和 type 不存在，则 ES 会自动创建。
  - ES 会自动设置每个文档的元数据。元数据的名字以一个下划线开头，如下：
    - `_index` ：该文档所属的索引名。
    - `_type` ：该文档所属的 type 名。
    - `_id` ：一个任意内容的字符串，默认是随机生成。同一 type 下，每个文档的 _id 值是唯一的。
    - `_source` ：一个字典，保存该文档的主体内容，即新增该文档时的 POST body 。 _source 字段没有建立索引，不支持直接搜索它。
    - `_version` ：一个从 1 开始递增的数字，表示该文档经过了几次写操作（包括 POST、PUT、DELETE）。
    - `_seq_no` ：一个从 0 开始递增的数字，表示这是对该 type 的第几次写操作。
    - `_primary_term` ：一个从 1 开始递增的数字，表示这是第几次 Primary Shard 。

- 可以将多个文档的数据保存在一个文件中，然后一次上传。如下：
  1. 将文档保存在 students.json 文件中，并且在每个文档之前声明 _id 的值，如下：
      ```json
      {"index": {"_id":"1"}}
      {"name": "Leo", "age": 10, "interests": ["sports", "music"]}
      {"index": {"_id":"2"}}
      {"name": "Jack", "age": 12, "interests": ["sports", "music"]}
      ...
      ```
  2. 以 `/$index_name/_bulk` 作为目标 URL ，发出 POST 请求：
      ```sh
      curl -X POST 127.0.0.1:9200/student/_bulk?pretty -H 'content-Type:application/json' --data-binary "@students.json"
      ```

### 删

- 相关 API ：
  ```sh
  DELETE /<index>/_doc/<_id>                  # 删除文档
  ```
- 例：删除文档
  ```sh
  [root@Centos ~]# curl -X DELETE 127.0.0.1:9200/student/_doc/8?pretty
  {
    "_index" : "student",
    "_type" : "_doc",
    "_id" : "8",
    "_version" : 2,
    "result" : "deleted",         # 已删除该文档
    "_shards" : {
      "total" : 2,
      "successful" : 1,
      "failed" : 0
    },
    "_seq_no" : 25,
    "_primary_term" : 1
  }
  ```
  ```sh
  [root@Centos ~]# curl -X DELETE 127.0.0.1:9200/student/_doc/8?pretty
  {
    "_index" : "student",
    "_type" : "_doc",
    "_id" : "8",
    "_version" : 3,
    "result" : "not_found",       # 该文档不存在
    "_shards" : {
      "total" : 2,
      "successful" : 1,
      "failed" : 0
    },
    "_seq_no" : 26,
    "_primary_term" : 1
  }
  ```
