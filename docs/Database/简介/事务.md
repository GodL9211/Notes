# 事务

数据库的事务是指完成一次读操作或写操作。

## ACID

为了避免执行事务时出错，数据库应该实现事务的 ACID 四种特性。

- **Atomicity（原子性）**
  - ：一个事务是像原子一样的基本单元，不能拆分。要么完成，要么不完成，不存在其它状态。
  - 为了保证原子性，当一个事务执行失败时，数据库应该恢复到执行之前的原状态。
- **Consistency（一致性）**
  - ：当多个用户同时访问数据库时，读取到的数据是完全相同的。
  - 通过并发锁可以让并发事务变成串行事务，保证一致性，但会降低并发性能。
  - 数据库本身可以阻止用户查看尚未同步的数据，从而保证一致性。
- **Isolation（隔离性）**
  - ：各个事务之间相互隔离。当一个事务失败时，不会拖累其它事务。
  - 隔离一个失败的事务有两种策略：乐观、悲观。
- **Durability（持久性）**
  - ：一个成功完成的事务会对数据库造成持久的影响（主要是指写入的数据不会丢失），只可能被后续事务的影响覆盖。

## 隔离级别

当事务A对一条数据进行写操作时，会影响对该数据进行读操作的其它事务。为此，SQL标准定义了4种事务的隔离级别，从低到高排列如下：
- Read Uncommitted（读取未提交内容）
  - 当事务A对数据进行了写操作但尚未提交时，其它事务也可以读到被修改之后的数据。
  - 如果事务A放弃提交，则其它事务读到的数据就是错的（这种问题称为“脏读”）。
  - 如果事务B重复读取该数据，而在此期间该数据被修改了，就会导致事务B读取到不同的数据。（这种问题称为“不可重复读”）
  - 如果事务B重复读取某个范围内的多行数据，而在此期间其它事务在该范围内新增了数据行，则事务B之后就会读取到突然出现的新数据。（这种问题称为“幻读”）
  - 这种隔离级别最不安全。
- Read Committed（读取已提交内容）
  - 当事务A提交之后，其它事务才可以读到被修改之后的数据，否则看到的是原数据。
  - 解决了“脏读”的问题，但是依然存在“不可重复读”、“幻读”的问题。
  - 这是大部分数据库的默认隔离级别。
- Repeatable Read（可重复读）
  - 保证一个事务在执行期间对同一数据的多次读取结果相同。
  - 依然存在“幻读”的问题。
  - 这是MySQL的默认隔离级别，并且 InnoDB 引擎通过多版本并发控制（Mutil-Version Concurrency Control，MVCC）解决了“幻读”的问题。
- Serializable（可串行化）
  - 当一个事务对数据进行写操作时，不允许其它事务对该数据进行读操作、写操作。（即加上排它锁）
  - 这种隔离级别最安全，但是事务的执行速度最慢。
