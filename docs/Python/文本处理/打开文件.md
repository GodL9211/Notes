# 打开文件

## 原理

- 处理文件内容的基本流程：
  1. 调用 open() 函数来打开文件，它会返回一个文件对象。
  2. 调用文件对象的方法，比如 read() 读取数据、 write() 写入数据。
  3. 调用文件对象的 close() 方法来关闭文件。

- 进程每打开一个文件，会自动分配一个 int 型的文件描述符，相当于每个文件的编号。
  - 关闭文件时，会自动关闭其文件描述符。
  - 文件被关闭之后，就不能再进行读写，否则会报错：`ValueError: I/O operation on closed file`
- 向文件读写数据时，默认会启用缓冲区。当程序请求读或写的数据达到一定字节数时，才进行实际的读或写操作。
  - 如果取消缓冲，则每读或写 1 个字节，就要与磁盘交互一次，容易经常等待磁盘 IO ，导致运行效率低。
- 读写文件时，有时需要声明换行符，用于自动划分每行文本。
  - 比如类 Unix 系统默认是 `\n` ，Windows 系统中的换行符默认是 `\r\n` 。

### 文件指针

读写文件时，Python 会通过文件指针记录当前处理到文件中的哪个字节了。
- 使用 r、w 模式打开文件时，指针最初指向第 0 个字节。
  - 每次读、写 n 个字节，就会自动将指针的位置向后移动 n 个字节。
  - 可以调用 f.seek() 来改变指针的位置。
- 使用 a 模式打开文件时，每次读、写操作之前，都会自动将指针指向最后一个字节。
  - 可以调用 f.seek() ，但每次读、写操作之前依然会将指针指向最后一个字节。

### 流对象

打开一个文件之后，是以流对象的方式进行读写：
- 二进制流
  - ：又称为字节流，以字节为单位进行读写。
  - 所有类型的文件都是以二进制格式存储的，因此可以按二进制流的形式直接读写。不过通常将二进制值转换成字节，便于阅读。
- 文本流
  - ：又称为字符流，以字符为单位进行读写。
  - 需要先读取文件的字节流，再按某种编码方式解码成字符流。
  - 使用文本流的主要问题是，解码时可能出错。

## open()

```py
open(                     # 用于打开文件，返回一个文件对象，可以读写数据
      file,               # 指定要打开的文件路径，或者一个 int 型的文件描述符
      mode      = 'r',    # 打开文件的模式
      buffering = -1,     # 缓冲策略
      encoding  = None,   # 编码格式，仅在文本模式可用
      errors    = None,   # 处理编码、解码错误的策略，仅在文本模式可用。取值为 None 时相当于 'strict' ，会抛出异常
      newline   = None,   # 换行符，仅在文本模式可用
      closefd   = True,   # 输入文件描述符打开文件时，调用 close() 方法是否关闭该文件描述符
      ...)
```
- mode 关于文件读写方式的取值：
  - `r`
    - ：read ，只读模式，默认采用这种。
    - 如果文件不存在，则会报错：`FileNotFoundError: No such file or directory`
  - `w`
    - ：write ，只写模式。
    - 如果文件不存在，则自动创建它，再进行写入。
    - 如果文件已存在，则将长度截断为 0 ，再进行写入。
  - `a`
    - ：append ，追加写模式。
    - 如果文件不存在，则自动创建它，再进行写入。
    - 如果文件已存在，则到文件尾部进行追加写入。
  - `x`
    - ：create ，先创建文件，再以只写模式打开。
    - 如果文件已存在，则会报错：`FileExistsError: [Errno 17] File exists`
  - `+`
    - ：可读可写模式。
    - 必须与 r、w、a、x 模式其中之一组合使用，比如 `r+`、`w+` 。
- mode 关于文件流类型的取值：
  - `t`
    - ：text ，文本模式，读写的值是 str 类型。
  - `b`
    - ：binary ，二进制模式，读写的值是 bytes 类型。
  - 打开文件时，t、b 模式只能二选一。
    - 必须与一种读写方式组合使用，比如 `rt`、`rb`、`rb+` 。
    - 只指定读写方式时，默认采用 t 模式，比如 `r` 相当于 `rt` 。
- buffering 的取值：
  - `0` ：取消缓冲，仅在二进制模式可用。
  - `1` ：采用行缓存，仅在文本模式可用。
  - `n` > 0 ：采用 n 字节大小的缓冲区。
  - 默认不指定缓冲策略，会自动根据文件类型确定缓冲区的大小，比如采用磁盘的块大小 4096 Bytes 。
- encoding 的取值：
  - 常用的比如 'utf-8'、'gbk' 。
  - 如果不指定 encoding 参数，Python 会采用当前平台的默认编码格式（取决于 `locale.getpreferredencoding(False)` ）。
    - 在 Linux 系统上，它通常是 'utf-8' 。
    - 在 Windows 中文版系统上，它通常是 'cp936' 。
- newline 的取值：
  - 默认为 newline=None ：
    - 读取文件时，会将文件中的 '\r'、'\n'、'\r\n' 都识别成换行符，并且统一转换成 '\n' ，再返回。
    - 写入文件时，会将待写文本中的 '\n' 都替换成当前平台的默认换行符（取决于 `os.linesep` ），再写入文件。
    - 建议不指定 newline ，让 Python 自动识别换行符，提高兼容性。
  - 如果指定了 newline='' ：
    - 读取文件时，会将文件中的 '\r'、'\n'、'\r\n' 都识别成换行符，然后返回该行文本。
    - 写入文件时，会直接写入。
  - 如果指定了 newline 等于其它值：
    - 读取文件时，只会识别指定的换行符，然后返回该行文本。
    - 写入文件时，会将待写文本中的 '\n' 都替换成指定的换行符，再写入文件。


