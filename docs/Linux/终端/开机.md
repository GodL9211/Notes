# 开机

Linux 系统的启动（boot）过程：
1. 计算机接通电源，启动 ROM 中的 BIOS(Basic Input Output System)系统。
2. BIOS 系统会通电检查 CPU、内存等计算机硬件，确定它们正常之后，就到硬盘的第一个扇区中找到 Bootloader 程序，读取并运行它（将 CPU 的控制权转交给它）。
   <br>Linux 系统常见的 Bootloader 程序是 grub ，它允许用户在开机时从多个操作系统中选择一个启动。
3. Bootloader 程序会根据硬盘分区表找到硬盘中存储的 Linux 内核文件，读取并运行它（将 CPU 的控制权转交给它）。
4. 内核创建的第一个进程是 idle ，PID 为 0 。
   <br>idle 进程是内核态进程，是唯一一个不通过 fork 或 kernel_thread 创建的进程。
   <br>idle 进程会通过 kernel_thread 创建 init 进程。
5. 内核创建的第二个进程是 init ，PID 为 1 。
   <br>如果/sbin/init 不存在，内核就会尝试运行/bin/sh ，再失败的话则系统启动失败。
6. 内核创建的第三个进程是 kthreadd ，PID 为 2 。
   <br>kthreadd 负责管理所有内核态进程。

## init

：所有用户态进程的父进程。

当 init 启动时，它会
- 读取 /etc/inittab 文件，启动当前 init 级别下的各个进程（比如执行 getty 创建终端）。
- 根据 /etc/fstab 文件中的磁盘分区信息，挂载各个文件系统。
- 启动 /etc/init.d 目录下的各个系统服务（大多是脚本）。

init 有七种运行级别（run level）：
- 0 ：关机。
- 1 ：单用户模式（simple mode），又称为紧急模式（emergency mode），可以在忘了 root 密码时修改密码。
- 2 ：多用户模式。
- 3 ：终端模式。
- 4 ：保留。
- 5 ：图形界面模式。
- 6 ：重启。

命令：

```sh
$ init n      # 切换运行级别
```

## 关机命令

> 执行关机命令时需要 root 权限。

```sh
$ sync        # 关机前先执行 sync 命令，将内存中的数据保存到磁盘
```

```sh
$ shutdown    # 在一段时间后关机（执行 init 0 来关机）
          -c  # 取消即将进行的关机
          -h 10 "This system will shutdown after 10 mins" # 10 分钟后关机，并将该消息广播给所有用户
```

```sh
$ poweroff    # 关机
```

```sh
$ halt        # 关机
```

```sh
$ reboot      # 重启
```

## service、chkconfig

System V 风格的类 Unix 系统中，使用 init 进程在系统启动时进行初始化，使用 service、chkconfig 命令来管理系统服务。

<details>
<summary>已淘汰不用</summary>

命令：

```sh
$ service
         <name>
         start         # 启动服务
         stop          # 停止服务
         restart       # 重启服务（先执行 stop 命令，再执行 start 命令）
         status        # 查看服务的状态
         --status-all  # 显示所有服务的状态
```

```sh
$ chkconfig 
           <name>      # 查看某服务是否开机自启动
           on          # 设置某服务开机自启动
           off         # 不开机自启动
           --list      # 列出所有已启动的服务
```

</details>

## systemctl

RHEL 7 开始使用 systemd 进程代替 init 进程，使用 systemctl 命令代替 service、chkconfig 命令。
- 用 systemctl 命令可以与 systemd 进行交互，从而管理系统。

systemd 以 unit 为单位管理系统。每个 unit 保存为特定后缀名的文件。常见的类型包括：
- .service ：系统服务
- .socket ：进程间通信的 socket 。
- .device ：硬件设备。
- .mount ：挂载点。
- .target ：一组 unit 。

命令：

```sh
$ systemctl
            start <unit>...         # 启动 unit（会将它变成 active 状态）
            stop <unit>...          # 停止 unit
            restart <unit>...       # 重启 unit（先执行 stop 命令，再执行 start 命令）
            reload <unit>...        # 重新加载 unit
            status <unit>...        # 显示 unit 的状态
            is-active <unit>...     # 显示 unit 是否处于 active 状态
            show <unit>...          # 显示 unit 的配置信息

            enable <unit>...        # 启用 unit
            disable <unit>...       # 不启用 unit
            is-enabled <unit>...    # 查看 unit 是否被启用（从而会开机自启）

            list-units              # 显示已启动的 unit
                    --all           # 显示所有 unit
                    --type=service  # 显示指定类型的 unit
                    --failed        # 显示启动失败的 unit

            rescue                  # 使系统进入救援模式
            emergency               # 使系统进入紧急模式
```
