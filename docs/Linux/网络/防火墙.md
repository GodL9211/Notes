# 防火墙

：用于保护计算机的网络安全。

## iptables

RHEL7 之前的 Linux 默认使用 iptables 工具来管理防火墙。
- 安装：yum install iptables-services
- iptables 会将用户配置的规则传给内核的 netfilter 网络过滤器处理。
  - netfilter 会从上到下读取用户配置的规则，一旦找到匹配的规则就立即执行，没有找到则执行默认规则。
- 常见的几类规则：（每类规则称为一个规则链）
  - INPUT ：处理接收的数据包。
  - OUTPUT ：处理发出的数据包。
  - FORWARD ：处理转发的数据包。
  - PREROUTING ：在选择路由之前处理数据包。
  - POSTROUTING ：在选择路由之后处理数据包。
- 常见的几种动作：（称为 target）
  - ACCEPT ：允许数据包通过。
  - REJECT ：拒绝数据包通过，并回复一条拒绝信息给发送方。（REJECT 不能用作默认动作）
  - DROP ：丢弃数据包，并且不作出回复。（这会导致发送方误以为网络不通）
  - LOG ：记录日志。
- iptables预设了三张规则表：nat、mangle、filter。
  - 每张表预设了多个规则链。
  - 默认使用的表是filter，用于配置基本的流量出入规则。

命令：
```sh
$ iptables
          -L [chain]          # 显示所有规则（或只显示某个规则链）
            -n                # 将服务名显示成具体的端口号
            -v                # 显示详细的信息
            --line-numbers    # 显示行号
          -I [n] <chain>      # 编辑某个规则链，插入一条新规则到第 n 行（默认是第一行）
          -A <class>          # 编辑某个规则链，添加一条新规则到最后一行
          -D <class> [n]      # 删除规则链的第 n 行（默认是删除所有行）
          -F [chain]          # 清空某个规则链（不指定 chain 则清空所有规则链）
          -P <chain> <target> # 设置某个规则链的默认动作

          -p <protocal>       # 指定协议
          -s <ip>             # 指定源地址
          -d <ip>             # 指定目的地址
          --sport <n>         # 指定源端口
          --dport <n>         # 指定目的端口
          -i eth0             # 指定网卡
          -j <target>         # 指定动作
          -t filter           # 指定表
```
- 例：
    ```sh
    iptables -F                          # 删除所有规则
    iptables -D INPUT                    # 删除 INPUT 规则链
    iptables -P INPUT DROP               # 设置 INPUT 规则链的默认动作为 DROP
    iptables -I INPUT -p icmp -j ACCEPT  # 在 INPUT 规则链的开头插入一条新规则，允许 icmp 数据包
    iptables -A INPUT -p tcp --dport 22 -j REJECT  # 拒绝其他 IP 地址发送 tcp 数据包到 22 端口
    iptables -I INPUT -p tcp -s 192.168.10.0/24 --dport 22 -j ACCEPT  # 允许指定 IP 地址网段发送 tcp 数据包到 22 端口
    ```
- 修改了 iptables 的规则之后要执行以下命令进行保存，否则系统重启后会复原。
    ```sh
    service iptables save
    ```
- 例：
  ```sh
  [root@Centos ~]# iptables -nvL  INPUT  --line-numbers 
  Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
  num   pkts bytes target     prot opt in     out     source               destination         
  1     2819  446K ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80
  2    50557  383M ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED
  3        0     0 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0           
  4       53  4960 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate INVALID
  5      484 26644 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited
  ```
  - pkts：该规则已匹配的数据包数。
  - bytes：该规则已匹配的数据包总大小。
  - target：该规则采取的动作。
  - prot：该规则针对的协议。
  - opt：该规则的选项。
  - in：该规则针对从哪个网卡流入的数据包。
  - out：该规则针对从哪个网卡流出的数据包。
  - source：该规则针对哪个源地址的数据包。
  - destination：该规则针对哪个目的地址的数据包。

## firewalld

RHEL7 之后的 Linux 上默认使用 firewalld 工具来管理防火墙。
- firewalld 会将用户配置的规则传给内核的 nftables 处理。
