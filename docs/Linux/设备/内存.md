# 内存

：Memory，又称为内部存储器、主存储器、物理内存。
- 内存能被CPU直接读写，用于暂时保存CPU处理的数据。
- 内存一般比外存的读写速度快，但是存储容量小。
- 一个内存条包含几个内存芯片以及外围电路，每个内存芯片中都集成了大量的内存颗粒。

## 分类

- ROM（Read Only Memory）：只读存储器，用于永久性地保存一些数据（比如BIOS），断电后数据不会丢失。
- RAM（Random Access Memory）：随机存储器，可以在任意位置读写数据，断电后数据就会丢失。

## Swap

：交换分区，一个特殊的磁盘分区。
- 作用相当于Windows系统的磁盘虚拟内存。
  - 当page数不足时，MMU会将page中某些暂时不用处理的数据暂时移到Swap分区中（称为swap out）。
  - Windows中即使没用完物理内存也可能使用虚拟内存，而Linux中只有用完了物理内存才会使用swap分区。
- 分配Swap分区有利于维持系统的稳定，但是Swap交换会让CPU直接从磁盘读写数据，导致CPU运行速度变慢，还会增加磁盘IO压力。
  - 因此，如果系统内存不是太少，可以禁用swap。

## 缓存

一般的计算机中，内存的读写速度比磁盘快很多，而CPU的读写速度又比内存快很多。如果CPU直接读写内存或磁盘，就要浪费时间去等待对方。因此要让CPU使用缓存。

Buffer：用于缓存CPU要写入磁盘的数据。
- 作用：
  - 让CPU与磁盘异步工作，不必等待磁盘IO。
  - 将数据累积到一定量之后再写入磁盘，降低磁盘的IO压力。

Cache：用于缓存CPU从内存或磁盘读取的数据。
- 当CPU要读取某个数据时，会先到Cache中寻找它。有以下两种情况：
  - cache hit ：在Cache中找到了，便可以立即读取它，节约了时间。
  - cache miss ：在Cache中没找到。此时需要再去内存中寻找，如果内存中也没有就要从磁盘载入。
- CPU第一次启动一个进程时会将进程的数据保存一份到cache中，当下一次启动该进程时会从cache中更快地载入。这样能提高CPU的载入速度。
  - 系统运行一段时间之后，cache会越来越大，占用越来越多的free内存。这样能提高内存使用率。
- CPU通常根据 LRU 算法来安排缓存的数据，大概率提高CPU读取数据时的cache hit率。

## 内存管理

MMU：内存管理单元。
- 以page为单位管理内存，每个page为 4 KB 。
- 当page数不足时，MMU可能采用三种措施：
  - 回收最近不用的page。
  - 将不常用的内存数据从page移到swap分区。
  - 通过OOM杀死某些占用大量内存的进程。
- MMU为每个进程都维护了一张页表（page table），将虚拟内存中要用到的内容映射到物理内存的一些page中，供CPU访问。
  - 这些page的集合称为该进程的working set。
  - 如果CPU在内存中没有找到进程的page，就会抛出缺页异常（page fault），调用缺页异常处理程序。这可能是因为数据还没有被MMU载入内存（称为主缺页异常，需要等待磁盘IO）、数据被载入内存了但是找不到或不能访问（称为次缺页异常）。
  - 当程序申请动态分配一块内存时，并不会立即获得该内存，而是等到它使用该内存时，CPU会发现该内存不存在而报出缺页异常，MMU才将实际内存分给它。
- dirty page：从磁盘加载到缓存中的数据被CPU改动了，与磁盘中的原数据不一致，需要写入磁盘保存。

OOM（Out of Memory）：一种管理内存的服务，用于在系统内存不足时自动杀死某些进程。
- 给每个进程评一个oom_score，进程占用的内存越多、占用的CPU越少，其oom_score的值越大，越容易被OOM杀死。
- 用户可以手动设置进程的oom_score。

## 虚拟内存空间

每个进程都运行在一个独立的虚拟内存空间中，就像系统中只有它一个进程。

比如在一个32位、4G内存的系统中，每个进程独享一个4G的虚拟内存空间。
- 高地址的1G空间为内核内存空间，只能被内核态进程访问。
- 低地址的3G空间为用户内存空间，可以被用户态进程访问。
  - 用户空间又分为五个部分：文件映射区、数据区（存储全局变量等）、只读区（存储代码、常量等）、堆区、栈区。
  - 不同进程之间访问不到对方的用户内存空间，只能通过内核内存空间进行通信。

## 相关命令

```shell
$ free            # 显示内存的使用情况
      -h          # 显示让人易读的单位（默认单位为 KB）
      -w          # 拉宽显示更多信息
      -s 1 -c 10  # 每隔一秒显示一次，最多显示10次
```
- 例：
    ```
    [root@Centos ~]# free -wh
                  total        used        free      shared     buffers       cache   available
    Mem:           7.8G        7.1G        543M         17M         33M        190M        636M
    Swap:            0B          0B          0B
    ```
    - total：物理内存的总量。total = used + free + buffer + cache
    - used：已用内存。
    - free：空闲内存。表示既没有被使用，也没有被划分成缓存的内存。
    - shared：共享内存，被多个进程共享。
    - buffers
    - cache
    - available：可用内存，包括free内存和可被回收的缓存。
    - **free内存较少并不代表物理内存紧张，因为系统可以回收大量缓存。当available内存较少、甚至Swap分区被使用时，才说明物理内存紧张。**

```shell
$ sync    # 将Buffer中的数据立即写入磁盘
```
- 默认会等缓存满了才写入磁盘，如果此时系统断电就会丢失数据。
