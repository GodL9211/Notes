# 用户

用户分类：
- 管理员用户：UID为0，名为root。
- 系统用户：UID为1~999。
- 普通用户：UID从1000开始。

一般的用户都会被分配一个独立的主目录（又称为家目录），默认为 /home/user/ ，比如leo的家目录就是 /home/leo 。
- root用户的家目录是 /root 。
- 在终端中可以用`~`指代家目录，例如执行 cd ~ 即可进入家目录（执行cd也行）。

用户组：可包含多个用户，便于统一管理。
- 每个用户有且仅有一个基本用户组，可以添加多个扩展用户组。
- 系统基于UID、GID来识别用户、用户组。多个用户可以使用相同的UID，多个用户组可以使用相同的GID。

## 相关文件

`/etc/passwd`文件中保存了所有用户的简介信息，允许被所有用户读取。如下：

    root:x:0:0:Superuser:/:
    daemon:x:1:1:System daemons:/etc:
    bin:x:2:2:Owner of system commands:/bin:
    sys:x:3:3:Owner of system files:/usr/sys:

- 每行的格式为`用户名:密码（不显示）:用户ID:组ID:描述信息:主目录:登录Shell`。
- 伪用户：有些用户没有登录shell，系统创建它们是为了方便管理。
- /etc/passwd文件可以被所有用户读取。

`/etc/shadow`文件中保存了加密后的用户密码，只允许被root用户读取。如下：

    root:$6$4jYHVJzl2zLgCJSrRJjyigxoP:18223:0:99999:7:::
    nobody:*:17834:0:99999:7:::
    sshd:!!:18178::::::
    nginx:!!:18224::::::

- 每行的第一个字段是用户名，第二个字段是用户加密后的密码。其中，* 表示该用户被锁定，!! 表示密码已过期。

`/etc/group`文件中保存了所有用户组的信息，每行的格式为“组名:密码:组ID:组内用户列表”。如下：

    root::0:root
    bin::2:root,bin
    sys::3:root,uucp

## 管理用户

```shell
useradd leo            # 创建一个用户
        -g <group>     # 指定基本用户组（默认会创建并划分到一个与该用户同名的基本用户组）
        -G <group>...  # 指定扩展用户组
        -d /usr/leo    # 指定家目录
        -s /bin/bash   # 指定shell解释器（默认为/bin/bash）
        -c <描述>      # 加上描述信息
        -e 2019-08-01  # 设置该用户的过期时间

usermod -s /sbin/nologin leo  # 修改用户的登录shell
    -dm /usr/leo              # 修改家目录并将旧的家目录的文件移动过去
```

- 用useradd创建用户之后，初始密码是过期的，要用passwd命令修改密码。
- 登录shell为/sbin/nologin表示禁止该用户登录。
- usermod命令支持useradd命令的选项。

```shell
userdel <user>  # 删除一个用户，并删除其主目录
        -r      # 同时删除其主目录和mail文件
        -f      # 强制删除

passwd [user]   # 修改用户的密码（默认是当前用户）
        -d      # 删除用户的密码，使其登录时不再需要密码
        -l      # 锁定用户，使其不能登录
        -u      # 解锁用户
        -S      # 显示用户的密码状态（是否设置了密码、是否锁定）
```

- 普通用户使用passwd命令时只能修改自己的密码，并且要输入旧密码进行验证。

## 切换用户

```shell
su [user]               # 切换到指定用户（默认是root）
    -                   # 把shell也切换
    -c <command>        # 不切换用户，只是以指定用户的身份执行一条命令

sudo <command>          # 以root用户的身份执行命令
    -u <user> <command> # 以指定用户的身份运行命令（可以用用户名或用户ID指定）
    -l                  # 显示当前用户可通过sudo执行的命令
    -v                  # 请求验证密码（每次验证密码后，5分钟内再使用sudo会免验证）
    -k                  # 要求用户在下一次使用时验证密码
```

- `/etc/sudoers`文件中记录了哪些普通用户有权限使用sudo命令。如下：

  ```shell
  root   ALL=(ALL)  ALL    # 允许root用户在任何目录下以任何用户的身份执行任何命令
  %root  ALL=(ALL)  ALL    # 允许root用户组
  leo    ALL=(ALL)  NOPASSWD: /usr/bin/docker,/root/run.sh  # 允许leo用户不需要输入密码就执行规定的命令
  ```

- 只有root用户有权限编辑`/etc/sudoers`文件，不过应该通过执行`visudo`命令来编辑它。
- 普通用户执行sudo时需要输入自己的密码，而执行su - 时需要输入root的密码。因此，执行`sudo su -`即可使用自己的密码切换到root用户。

## 管理用户组

```shell
id                   # 显示当前用户的uid、gid、扩展用户组id
    <user>           # 显示指定用户的
    -u               # 只显示uid
    -g               # 只显示gid
    -G               # 只显示扩展用户组id

groups               # 显示当前用户所属的用户组（用su切换用户之后会改变）
    <user>...        # 显示指定用户所属的用户组

groupadd <组名>      # 增加一个用户组

groupmod <旧组名 <新组名>  # 修改用户组的名字
        -g <ID> <组名>    # 修改用户组的ID

groupdel <组名>      # 删除一个用户组
```
