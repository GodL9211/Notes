# 网络测试

## IP 测试

### ping

：常用于测试网络是否连通、网络延迟、域名解析。

原理：
- 基于 ICMP 协议，向目标主机发送 ICMP 报文，根据收到回复的时间间隔就可以知道通信延迟。
- ICMP 报文的头部用 1 个字节记录了该报文的生存期（Time To Live ，TTL）。
- ICMP 报文每经过一跳路由器，TTL 的值就会被减一，当 TTL 为零时路由器就会丢弃该报文。

命令：
```sh
$ ping <host>    # 启动 ping
        -c n     # 最多发送 ICMP 报文多少次（默认为无限次）
        -i n     # 每次发送 ICMP 报文的间隔时间（默认为 1 秒）
        -I eth0  # 使用本机的指定网卡来发送 ICMP 报文（默认自动选取网卡）
```
- host 可以是 IP 地址或域名，如果是域名，在执行时还会显示出域名解析后的 IP 地址。

例：
```sh
[root@Centos ~]# ping baidu.com
PING baidu.com (39.156.69.79) 56(84) bytes of data.
64 bytes from 39.156.69.79 (39.156.69.79): icmp_seq=1 ttl=250 time=37.0 ms
64 bytes from 39.156.69.79 (39.156.69.79): icmp_seq=2 ttl=250 time=37.0 ms
64 bytes from 39.156.69.79 (39.156.69.79): icmp_seq=3 ttl=250 time=37.0 ms
64 bytes from 39.156.69.79 (39.156.69.79): icmp_seq=4 ttl=250 time=37.0 ms
^C
--- baidu.com ping statistics ---
4 packets transmitted, 4 received, 0% packet loss, time 3003ms
rtt min/avg/max/mdev = 37.008/37.022/37.044/0.136 ms
```
- 可见它成功连接到目标主机，显示出 ping 的测试结果。
- icmp_seq ：表示这是第几个 ICMP 报文。
- ttl ：ICMP 报文剩下的生存期。
- time ：发出 ICMP 报文之后，隔了多久才收到回复。
- Linux 的 ping 命令默认每隔一秒向目标主机发送一个 ICMP 报文，并且会一直发送，要按 `Ctrl+C` 终止。

例：
```sh
[root@Centos ~]# ping google.com
PING google.com (93.46.8.90) 56(84) bytes of data.

^C
```
- 可见它一直尝试连接目标主机，但并没有成功。原因可能是：
  - 与目标主机的物理网络没有连通
  - 与目标主机的物理网络连通，但是目标主机没有开启 ICMP 协议

### traceroute

：用于查看发送一个数据包到目标主机时，要经过哪些路由。

命令：
```sh
$ traceroute <host>
```

### cip.cc

：一个公开的 Web 网站，访问之后会显示本机的公网 IP、地理位置、运营商。
- 不同场景的用法：
  - 在 Web 浏览器上，访问`cip.cc`网站。
  - 在 Unix/Linux 上，执行`curl cip.cc`。
  - 在 Windows 上，执行`telnet cip.cc`。
- 也可查询指定 IP 的信息：`curl cip.cc/8.8.8.8`
- 例：
    ```sh
    [root@VM_0_4_centos ~]# curl cip.cc
    IP      : 120.241.2.7
    地址    : 中国  广东  深圳
    运营商  : 移动
    数据二  : 广东省深圳市 | 移动
    数据三  : 中国广东深圳 | 移动
    ```

## TCP/UDP 测试

### 性能指标

- 接收速度、发送速度。
  - 带宽    ：网络的实际最大传输速率，由网卡和实际网络链路决定。（每个网卡的产品信息中还有一个理论带宽）
  - 吞吐量  ：没有丢包时的最大传输速率。吞吐量/带宽就是该网络链路的实际使用率。
- 接收包速、发送包速。
  - pps ：每秒收发的数据包数（packet per second），一般是指 TCP/UDP 包。
pps 主要受到网络带宽、从网卡到 CPU 收发网络包的速度影响。
采用最小的以太网帧（64 Bytes）、UDP 包（因为无需连接），可以测试出一个主机的最大收发 pps 。
  - 丢包率
  - 重传率：重新传输的数据包的百分比。
- 通信延迟：指建立 TCP 连接的耗时，或一个数据包往返的耗时。
- TCP 连接数

### nmap

：一个端口扫描工具。
- 安装：yum install nmap
- 命令：
    ```sh
    $ nmap
          192.168.0.1               # 扫描目标主机有哪些端口可以连接
          192.168.0.1/24            # 扫描一个网段，检测有哪些可连接的主机，并扫描它们的端口
          192.168.0.1 192.168.0-5.1 # 扫描多个主机
          -p 80,443                 # 只扫描指定端口（默认扫描常用的 1000 个端口）
          -A                        # 扫描各种信息（比如推测目标主机的操作系统、版本）
    ```

### iperf

：可以模拟服务端和客户端，从而测试任意两台主机之间的 TCP/UDP 带宽。
- 安装：yum install iperf
- 用法：
  - 先在一个主机上安装 iperf ，执行以下命令启动服务器，监听 80 端口：
      ```sh
      iperf -s -i 1 -p 80
      ```
  - 然后在另一个主机上安装 iperf ，执行以下命令启动客户端，开始测试：
      ```sh
      iperf -c <服务器 IP>:80 -p 80
      ```

### speedtest

：一个测试本机到公网的网速的工具，基于 Python 开发。
- 安装：pip install speedtest-cli
- 命令：
  ```sh
  speedtest-cli         # 开始测试
                --json  # 测试结果显示成 json 格式
  ```
- 例：
  ```sh
  [root@Centos ~]# speedtest-cli
  Retrieving speedtest.net configuration...
  Testing from Tencent cloud computing (129.204.40.71)...   # 发现本机的公网 IP
  Retrieving speedtest.net server list...
  Selecting best server based on ping...                    # 选择一个最近的 speedtest.net 服务器来测试
  Hosted by China Mobile Group Beijing Co.Ltd (Beijing) [1.69 km]: 50.546 ms
  Testing download speed................................................................................
  Download: 21.60 Mbit/s                                    # 下载速度
  Testing upload speed................................................................................................
  Upload: 22.35 Mbit/s                                      # 上传速度
  ```

### tcpdump

：一个 Linux 自带的网络抓包工具。
- 可以抓取主机网卡上收发的所有数据包。
- 命令：
    ```sh
    tcpdump
            -i lo         # 监听指定网卡（默认是监听第一个网卡，即 eth0）
            -n            # 将主机名、域名显示成明确的 IP 地址
            -nn           # 将端口名显示成明确的端口号
            -v            # 显示数据包的详细信息
            -vv           # 显示数据包更详细的信息

            # 过滤表达式
            host 10.0.0.1       # 指定主机
            net 10.0.0.1/24     # 某个网段
            src 10.0.0.1        # 指定源地址
            dst 10.0.0.1        # 指定目的地址
            tcp                 # 指定协议
            port 80             # 指定端口
            tcp and dst port 80 # 过滤出目的端口为 80 的 tcp 数据包

            -c 10               # 抓取指定数量的数据包之后就停止运行
            -w dumps.pcap       # 将抓取信息保存到一个文件中
    ```
    - 监听 eth0 网卡时，会抓取本机与其它主机通信的数据包。监听 lo 网卡时，会抓取本机内部通信的数据包。
    - 过滤表达式支持使用 and、or、not 运算符。
    - 可以先用 tcpdump 抓包并保存为文件，然后在 Wireshark 的 GUI 界面中分析。

- 下例是对一次 HTTP 请求的抓包：
    ```sh
    [root@Centos ~]# tcpdump -nn tcp and dst port 8000
    tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
    listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes
    13:46:14.669786 IP 10.124.128.97.52152 > 10.124.130.12.8000: Flags [S], seq 2920488928, win 29200, options [mss 1424,sackOK,TS val 3983484990 ecr 0,nop,wscale 7], length 0
    13:46:14.670038 IP 10.124.128.97.52152 > 10.124.130.12.8000: Flags [.], ack 174830516, win 229, options [nop,nop,TS val 3983484990 ecr 2392282894], length 0
    13:46:14.670095 IP 10.124.128.97.52152 > 10.124.130.12.8000: Flags [P.], seq 0:82, ack 1, win 229, options [nop,nop,TS val 3983484990 ecr 2392282894], length 82
    13:46:14.672466 IP 10.124.128.97.52152 > 10.124.130.12.8000: Flags [.], ack 18, win 229, options [nop,nop,TS val 3983484992 ecr 2392282896], length 0
    13:46:14.672591 IP 10.124.128.97.52152 > 10.124.130.12.8000: Flags [.], ack 378, win 237, options [nop,nop,TS val 3983484992 ecr 2392282897], length 0
    13:46:14.672667 IP 10.124.128.97.52152 > 10.124.130.12.8000: Flags [F.], seq 82, ack 378, win 237, options [nop,nop,TS val 3983484993 ecr 2392282897], length 0
    13:46:14.672805 IP 10.124.128.97.52152 > 10.124.130.12.8000: Flags [.], ack 379, win 237, options [nop,nop,TS val 3983484993 ecr 2392282897], length 0
    ```
    - 每行包含多个字段：时间戳 源地址 > 目的地址 Flags ... length
    - 常见的几种 TCP 数据包标志：
      - [S] ：SYN 数据包。
      - [.] ：ACK 数据包。
      - [S.] ：SYN+ACK 数据包。
      - [P] ：PUSH 数据包。
      - [F] ：FIN 数据包。
      - [R] ：RST 数据包。


## HTTP 测试

### 性能指标

- Req/Sec  ：每秒完成的请求数。
  - 测试 HTTP 通信时，web 客户端不能与 web 服务器在同一个主机上，否则没有通信延迟。
- HTTP 连接数

### ab

：原名为 Apache Benchmark ，用于对 HTTP 服务器进行压力测试。
- 安装：yum install httpd-tools
- 命令：
    ```sh
    ab -c 100 -n 10000 <服务器 IP>    # 模拟 100 个并发数，总共发送 10000 个请求报文
    ```

### wrk

：一个 HTTP 压测工具。

- 命令：
    ```sh
    wrk <服务器 IP>
        -t 12                   # 模拟的线程数
        -c 400                  # 模拟的连接数
        -d 30                   # 测试的持续时间
        -H "Connection: Close"  # 测试短连接（默认是长连接）
    ```
- wrk 运行结束之后会显示测试结果，主要指标为：
    - Latency ：响应时间
    - Req/Sec ：每个线程每秒钟完成的请求数
    - Stdev ：标准差

### Postman

：一个 HTTP 测试工具，主要用于 Web API 的功能测试。
- 提供了 GUI 操作界面，可以快速测试 Web API 。
- 可以将测试任务导出为 C、curl、Python 等形式的代码。
- 可以批量执行测试任务。

### Jmeter

：一个通用的网络测试工具，基于 Java 开发。
- 可作为命令行工具使用，也提供了 GUI 操作界面。
- 可测试 HTTP、FTP、MQTT 等多种通信协议，可进行功能测试、性能测试。
- 在左侧栏制定测试计划，然后点击 run 即可执行它。
- 测试计划中可以使用定时器等多种控件，实现丰富的控制逻辑。
