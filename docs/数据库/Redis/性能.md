
# 性能

## 缓存

当MySQL等数据库的读操作远多于写操作时，可以用Redis作为读缓存。
- 缓存机制：
  - 当用户查询某个Key时，先到Redis缓存中查询，如果查询不到再到数据库查询。这样可以降低数据库的压力。
  - 如果在数据库查询到了该key的值，则放入缓存，设置几分钟的过期时间。如果查询到的值为空，则不放入缓存。

缓存穿透：有恶意请求不断地查询一些不存在的key，绕过缓存，直接冲向数据库。
- 解决方案：
  - 即使查询到的值为空，也将该key放入缓存。
  - 在查询缓存之前，先过滤掉明显不正常的查询请求。

缓存击穿：大量请求一直频繁地查询某个key（称为热key），而该key在某一时刻缓存过期，导致这些请求直接冲向数据库。
- 解决方案：
   - 延长热key的过期时间。

缓存雪崩：在某一时刻，大量的普通key都缓存过期，导致它们的请求直接冲向数据库。
- 解决方案：
  - 给不同类型的key设置不同的缓存时长，给同一类型的key设置缓存时长时加上随机数，尽量分散缓存周期。
  - 将这些key存储在多个Redis上，分散查询请求。

## 性能优化

- Redis的QPS主要受网络延迟、CPU频率影响。
- Redis的读写速度很快，IO压力小。因此没有必要读写分离，只是需要横向扩容。
- 当系统内存不足时，Redis会卡顿，甚至可能被OOM杀死。

## redis-benchmark

：Redis官方提供的性能测试工具，安装Redis时会自带。

命令：
```shell
$ redis-benchmark
                  -h 127.0.0.1 # redis服务器的IP地址
                  -p 6379      # redis服务器的端口号
                  -a ******    # 密码

                  -c 50        # 模拟连接的client数（默认50个）
                  -n 100000    # 模拟发出的请求数
                  -l           # 循环测试，不停止
                  -d 3         # set、get时的value大小（默认为 3 bytes）
                  -r 10000     # 使用随机的名字创建key
                  -t set,get   # 只执行某些测试用例（默认执行所有测试用例）
                  -P 10        # 使用管道，每次通信发送10条命令（默认只发送一条）
```
- 例：
  ```shell
  redis-benchmark -h redis-1 -a ****** -t set,get
  ```
- 测试的是QPS，不会创建多少key、占用多少内存。
- 当 -c 太少时，QPS会比较小。当QPS达到瓶颈时，增加 -c 数，QPS也不会增加。
- 测试时会在Redis服务器的 0 号数据库中创建几个key，比如`mylist`、`key:__rand_int__`等。测试完之后不会删除。
- 使用 -r 10000 选项时，会使用10000范围内的随机数给key命名，例如：`key:000000000913`、`key:000000000882`

## 集群

Redis常见的集群方案：
- 主从+哨兵集群：类似Mysql的主从架构，加上哨兵实现自动主从切换，实现高可用。
- Codis集群
  - 分成多个独立工作的小组，每组是一个小的主从架构。
  - 用一个proxy统一管理所有组。
- Cluster集群：由Redis官方提出。
