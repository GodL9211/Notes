# 邮件协议

## 电子邮件（E-mail）

- 用户使用邮件客户端，就可以从邮件服务器接收、发送邮件。
- 电子邮件地址一般由邮箱名和邮件服务器的域名组成，中间用@隔开。比如：123456@qq.com
- 邮件服务器的主要配置内容：
  - 域：可以将一个邮件服务器分成多个独立的虚拟服务器，每个虚拟服务器都是一个域。
  - 用户：需要配置账号、密码，用于登录邮件服务器。
    - 每个用户会被分配一个唯一的电子邮件地址。
  - 用户组：将多个用户分为一组，给组地址（也是一个电子邮件地址）发邮件，该组的所有用户都会收到。

## 邮件协议

邮件协议主要有三种，都属于应用层协议。
- 简单邮件传输协议（Simple Mail Transfer Protocol，SMTP）：用于发送邮件到邮件服务器，只能发送纯ASCII码文本。
  - 采用C/S工作模式，默认使用TCP 25端口。
  - MIME是SMTP协议的一个扩展，使它能够发送非ASCII码的内容（包括汉字、二进制文件、音视频文件）。
- 邮局协议（Post Office Protocol，POP）：用于从邮件服务器拉取邮件。
  - 采用C/S工作模式，默认使用TCP 110端口。
  - 目前通常使用POP3版本。
- 因特网邮件访问协议（Internet Mail Access Protocal，IMAP）：用于从邮件服务器拉取邮件。
  - 比POP协议的功能更强，允许用户在下载邮件之前查看邮件的首部、检索邮件的内容、将客户端邮箱的状态同步到服务器。
  - 采用C/S工作模式，默认使用TCP 143端口。
  - 目前通常使用IMAP4版本。

一般的邮件收发流程：
1. 发送方的用户启动邮箱软件（此时是作为SMTP客户端），将邮件发送到SMTP服务器。
2. SMTP服务器将邮件转发到POP服务器或IMAP服务器。
3. 接收方的用户启动邮箱软件，通过POP或IMAP协议从服务器拉取邮件。

 
## ♢ smtplib

：Python的标准库，提供了SMTP客户端的功能。

例：
```python
import smtplib
from email.header import Header
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.mime.application import MIMEApplication


# 连接到SMTP服务器
# server = smtplib.SMTP(host="localhost", port=25)      # 连接到SMTP服务器
server = smtplib.SMTP_SSL(host="smtp.163.com", port=994, timeout=3)  # 基于SSL协议连接到SMTP服务器
server.set_debuglevel(1)                                # 显示与SMTP服务器的详细通信过程，便于调试
server.login("1234567@163.com", "******")               # 登录

# 创建邮件
email = MIMEMultipart()
email["From"] = Header("python smtplib", "utf-8")       # 注明发送者
email["To"] = Header("Leo", "utf-8")                    # 注明接收者
email["Subject"] = Header("这是一封测试邮件", "utf-8")   # 写入标题
content = "Python邮件发送测试..."
email.attach(MIMEText(content, "plain", "utf-8"))       # 写入邮件内容
# 将内容类型设置为"html"，就可以发送HTML格式的文本

# 上传附件（可照这样attach多个附件）
with open("1.jpg", "rb") as f:
    attachment = MIMEApplication(f.read())
    attachment.add_header("Content-Disposition", "attachment", filename="1.jpg")
    email.attach(attachment)

# 发送邮件
try:
    sender = "1234567@163.com"         # 发送方，填一个有效的邮箱地址
    receiver = "1234567@163.com"       # 接收方可以是一个序列，包含多个邮箱地址
    server.sendmail(sender, receiver, email.as_string())
finally:
    server.quit()                      # 关闭连接
```
 
## ♢ smtpd

：Python的标准库，可用于运行一个简单的SMTP服务器。

```python
import asyncore
import smtpd


class CustomSMTPServer(smtpd.SMTPServer):
    def process_message(self, peer, mailfrom, rcpttos, data, **kwargs): # 重载处理邮件的方法
        print("\n\n# Received email")
        print("From: ", mailfrom, peer)
        print("To: ", rcpttos)
        print("raw_data: ", data)

server = CustomSMTPServer(("127.0.0.1", 25), None)    # 创建SMTP服务器，设置监听的IP和端口
asyncore.loop()                                       # 异步循环运行
```

## ♢ poplib

：Python的标准库，提供了POP客户端的功能。

例：
```python
server = poplib.POP3_SSL(host="pop.163.com", port=995, timeout=3)   # 连接到POP服务器
server.user("1234567@163.com")
server.pass_("******")

res, _list, octets = server.list()      # 获取服务器上的邮件列表（只是每个邮件的序号加邮件大小）
res, raw_data, octets = server.retr(i)  # 下载服务器上的第n条邮件（接下来需要解析raw_data）
server.dele(n)                          # 删除服务器上的第n条邮件
server.quit()                           # 断开连接
```
