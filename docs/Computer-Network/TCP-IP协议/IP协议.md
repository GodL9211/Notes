# IP协议

TCP/IP协议簇包含IP、TCP、UDP等多种协议，是因特网的核心通信协议。

## IP协议

：因特网协议（Internet Protocol）
- 属于网络层协议，规定了网络上的主机用IP地址确定自己的身份。
- 面向无连接，只提供尽力而为的数据传输服务：只管把数据发送出去，不进行差错控制。
  - 是不可靠的通信协议。
- 通过IP协议，主机可以加入一个专有网络或因特网。
  - 私有IP：接入专有局域网的每台主机都必须被分配一个该局域网的IP地址。
    - 一个主机可以拥有同一个网络的多个IP地址，也可以拥有不同网络的多个IP地址。
  - 公有IP：接入因特网的每台主机都必须被分配一个公有IP地址。
- IP协议主要有IPv4、IPv6两个版本，后者尚未普及。

## IPv4

IPv4地址的长度为32位，分为4个字段，每个字段有8位，用点分十进制表示就是每个字段有一个0~255的十进制数。
- 采用“网络号+主机号”的结构，每个网络号表示一个逻辑网络。

根据开头几位的不同，可将IPv4地址分为5类：
- A类地址
  - 以一个0开头，网络号占8位，主机号占24位，取值范围为`0.0.0.0~127.255.255.255`。
  - 第一个字段有2^7=128个可能值，取值范围为0~127。
  - 排除网络号全为0的IP地址、专有地址`10.*.*.*`、环回地址`127.*.*.*`之后，可分配的网络号有125个。
    - 每个网络排除全为0、全为1的主机号之后，可分配的主机号有224-2个。
    - 因此，可分配的A类地址总共有231个左右，占全部IP地址的一半。
  - A类的专有地址：`10.*.*.*`
- B类地址
  - 以10开头，网络号占16位，主机号占16位，取值范围为`128.0.0.0~191.255.255.255`。
  - 第一个字段有2^6=64个可能值，取值范围为128~191。
  - 可分配的网络号有214个，每个网络可分配的主机号有216-2个。
  - B类的专有地址：`172.16.*.*~172.31.*.*`，共16个网络号。
- C类地址
  - 以110开头，网络号占24位，主机号占8位，取值范围为`192.0.0.0~223.255.255.255`。
  - 第一个字段有2^5=32个可能值，取值范围为192~223。
  - 可分配的网络号有221个，每个网络可分配的主机号只有28-2=254个。
  - C类的专有地址：`192.168.*.*`，共256个网络号。
- D类地址
  - 以1110开头，用于多播地址，取值范围为`224.0.0.0~239.255.255.255`。
- E类地址
  - 以11110，保留给实验或未来使用，取值范围为`240.0.0.0~247.255.255.255`。

以下IP地址不能用于因特网：
- 专有IP地址   ：保留给专有网络使用。这样当主机接入因特网时，路由器能识别出该IP是私有IP从而忽视它。
- `127.*.*.*`  ：环回地址（lookback、localhost）。
  - 发向该IP地址的数据包会直接回送到本机，不会被网卡发出去。
  - 127.0.0.0是网络号，一般使用127.0.0.1。
  - 环回地址对应的子网掩码为255.255.255.255。
- 网络号全为0   ：表示只发送给本网络的主机。
  - 数据包会被路由器限制在本网络内，发送给主机号对应的主机。
- 主机号全为0   ：是该网络本身的网络号。
- `0.0.0.0`
  - 在路由表中用作默认网关，没有找到路由的数据包都会转发给默认网关。
  - 如果服务器监听0.0.0.0，则会接受来自任何IP地址的访问。
- 主机号全为1   ：直接广播地址，数据包会被广播给该网络内的所有主机。
- IP地址全为1   ：受限广播地址，数据包会广播给本网络内的所有主机。
  - 对应的MAC地址为ffff.ffff.ffff。

## IPv4短缺问题

IPv4地址短缺的问题越来越严重，原因包括：
- B类地址的一个网络中可分配的主机号太多，实际接入的主机少，即使接入了这么多主机也会因为路由表太大增加路由器的负担，导致网络服务质量下降。
- C类地址可分配的网络号很多，但每个网络中可分配的主机号较少，只适用于小型局域网。

为了解决IPv4地址短缺的问题，人们采用了以下对策：
- 划分子网（subnet）
  - ：将一个容量大的网络分成几个子网络，将IP地址改成“网络号+子网号+主机号”的三级结构（只适用于A、B、C类地址），然后用“IP地址 子网掩码”来表示这个子网，也可以用“IP地址/子网掩码长度”的形式表示。
  - 网络号和子网号对应位的子网掩码（subnet mask）全为1，主机号对应位的子网掩码全为0。一个子网IP地址与其子网掩码按位与的结果就是其子网号。
  - 例如：对于192.168.0.0，该网络可容纳28-2个主机，从8位主机号中取出前一位，便可划分192.168.0.0/25和192.168.0.128/25两个子网，每个子网可容纳27-2个主机。再将192.168.0.128/25的子网掩码延长一位，又可划分两个子网，每个子网可容纳26-2个主机。每个网络去掉全为0和全为1的主机号后，可知在192.168.0.128/25这个子网中，第一个可用的IP地址是192.168.0.129/25，最后一个可用的IP地址是192.168.0.254/25。
  - 不划分子网时，A类地址的默认子网掩码是255.0.0.0，B类地址的默认子网掩码是255.255.0.0，C类地址的默认子网掩码是255.255.255.0。
  - 子网掩码为255.255.255.255表示这个子网只有一个主机，通常用于环回接口。
- 构成超网（supernet）的无类别域间路由（CIDR）技术
  - ：将网络号前n位相同的网络看作同类并合并为一个网络，又称为地址聚合、路由聚合。
  - 例如：192.168.0.129与192.168.0.130的前30位相同，聚合后的网络为192.168.0.128/30。
  - 例如：汇聚 .01010000与 .01010001 、 .01010010时，三个IP地址的前30位相同，但是只有两位主机号，去掉全为0和全为1的主机号后只能分配两个主机号，所以聚合后的网络应该为 .01010000/29。又因为 .01010000这个地址已经被占用，为了避免发生冲突，要一直退位，所以聚合结果为 .01000000/27。
- 网络地址转换（Network Address Translation，NAT）
  - ：平时给主机分配专有IP，当主机联网时才换成公用IP地址。
  - 该技术多用于拨号上网：拨号时主机被ISP分配一个公用IP地址，联网结束时被收回。
- 使用IPv6地址
  - 能从根本上解决IPv4地址短缺的问题。
  - 不过全面更换IP地址需要的时间久，导致IPv6地址还不能通用。

## IPv6

- IPv6地址的长度为128位，分为8个字段，每个字段有16位，用冒号十六进制表示就是每个字段有4个0~F的十六进制数。
- 每个字段前面的0可以省略，不过每个位段至少要有一个数字，或者连续几个位段全为0时可以省略它们而用双冒号表示。
  - 双冒号不可以出现两次，否则无法判断省略的位数。
  - 例如：0000:210A:0000:0000:02AA:000F:0000:0000可简写成0:210A:0:0:2AA:F:0:0，再进一步可简写成0:210A::2AA:F:0:0或0:210A:0:0:2AA:F::。
- IPv6协议具有巨大的地址空间、新的协议格式、有效的分级结构等优点。
