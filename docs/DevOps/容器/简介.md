# 简介

## 虚拟化技术

运行多个进程时，隔离它们的运行环境有利于管理。可采用以下方法进行隔离：
- 运行多个物理主机
  - 这样冗余很多，成本高。
- 在物理机上运行多个虚拟机
- 在主机上运行多个容器
  - 容器比虚拟机的开销低很多。
  - 运行容器的主机称为宿主机，可以是物理机或虚拟机。

## Hypervisor

：又称为 VMM（Virtual Machine Monitor ，虚拟机监视器）
- 原理：在计算机硬件与操作系统之间隔离出一个中间层，用于运行虚拟化的操作系统。
- 缺点：每创建一个虚拟机实例都要重新拷贝、安装一个完整的操作系统和运行环境，浪费时间。而且，发布应用软件时需要考虑不同环境的兼容问题，很麻烦。
- 常见的创建虚拟机的软件：
  - KVM
  - VirtualBox
  - Xen
  - VMwareWorkstation
  - Windows Hyper-V

## 容器

：新一代的虚拟化技术，比虚拟机轻量很多。
- 原理：
  - 在应用软件与操作系统之间隔离出一个中间层，用于运行容器。
  - 以镜像作为模板，在主机上创建容器并保持运行。
- 优点：
  - 虚拟化效果接近虚拟机
    - 能隔离进程的运行环境。
    - 能限制进程占用的资源。
  - 轻量级
    - 容器的开销比虚拟机低很多，冗余少。
  - 便于管理进程
    - 包含了进程管理工具的功能，比如启动、停止、自动重启。
    - 进程及其子进程都运行在容器中，不会游离到容器外。
  - 兼容性好
    - 同一个镜像可以拷贝到不同平台上，创建容器，只需系统内核相同。
    - 便于将应用迁移部署到其它主机。
    - 便于将应用部署多个实例。

### 相关历史

- 1979 年，Unix 系统加入了 chroot 技术（change root directory），用于更改正在运行的进程的根目录。
  - 这里是指文件系统的根目录，不是指当前的工作目录。
  - 更改根目录时，需要先拷贝 /lib 等库文件到新的根目录下，供进程调用。
- 2002 年，Linux 系统加入了 namespace 技术，用于隔离进程可见、可用的系统资源。
- 2008 年，Linux 系统加入了 Control group 技术，简称为 Cgroup ，用于限制进程及其子进程占用的 CPU、内存、磁盘 IO 等系统资源。
- 2008 年，Linux 系统加入了 LXC 工具，可用于控制 namespace 和 Cgroup 。
  - Docker 最初是通过 LXC 来控制 namespace、Cgroup ，实现容器化。从 v0.9 版本开始，弃用 LXC ，改用 libcontainer 等 Golang 库。

### 相关概念

- OCI（Open Container Initiative，开放容器倡议）
  - 该组织于 2015 年创立，负责制定容器行业的镜像规范、容器运行时规范。
  - 符合 OCI 标准的镜像，可以被符合 OCI 标准的容器运行时读取，从而创建容器。
- 容器引擎（Container Engine）：负责与用户交互、管理镜像，基于容器运行时来管理容器。
- 容器运行时（Container Runtimes）：负责管理容器，是被容器引擎调用的底层组件之一。
- 容器平台：整合了容器引擎、容器运行时等组件，可以独立运行，负责创建容器、运行容器。
- 容器平台举例：
  - LXC（Linux Container）
  - Docker
  - rkt（CoreOS Rocket）
  - Windows Hyper-V Containers

- 单独的容器引擎举例：
  - Podman
    - 与 Docker 引擎的用法相同，兼容 CLI 命令。
    - LXC、rkt、Podman 不需要运行一个守护进程来管理容器，避免了单点故障。

- 单独的容器运行时举例：
  - runC ：轻量级，兼容性高，用于将容器移植到不同平台。

- 容器运行时接口（Container Runtime Interface，CRI）：该接口将 kubelet 与容器运行时解耦，允许 k8s 使用多种容器运行时。
  - containerd
    - 借鉴了 runC ，可用作 Linux、Windows 上管理容器的守护进程。
    - runC、containerd 最初是 Docker 中的组件，后来成为一个独立的模块。
  - CRI-O

### 容器编排工具

当容器数量较多时，手动管理很麻烦，需要使用容器编排工具。常见的如下：
- Docker Compose ：由 Docker 公司推出，只能管理当前宿主机上的容器，不能管理服务器集群。
- Docker Swarm ：由 Docker 公司推出，可以管理多台宿主机上的容器。
- Mesos ：由 ASF 管理。
- Kubernetes ：由 Google 公司推出，功能完善但也很复杂，通过命令行操作。
  - Rancher ：由 Rancher Labs 公司推出，是基于 k8s 封装的 Web 平台。
  - OpenShift ：由 Red Hat 公司推出，是基于 k8s 封装的 Web 平台。
