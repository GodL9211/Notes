# 部署

- k8s 有多种部署工具：
  - kubeadm ：官方的部署工具。
  - minikube ：用于部署测试用途的 k8s 。
- 也可使用云平台部署的 k8s ：
  - Elastic Kubernetes Service（EKS）：由 AWS 云平台提供。
  - Azure Kubernetes Service（AKS）：由 Azure 云平台提供。
  - Google Kubernetes Engine（GKE）：由 Google 云平台提供。
  - Tencent Kubernetes Engine（TKE）：由腾讯云提供。
- 还可使用一些 k8s 发行版。它们基于 k8s ，并封装了其它组件，比如 Web UI、网络插件。
  - Rancher ：由 Rancher Labs 公司开源。
  - OpenShift ：由 Red Hat 公司开源。
  - kubesphere ：由青云公司开源。
  - KubeOperator ：由飞致云公司开源。

## kubeadm

：一个命令行工具，用于部署标准的 k8s 集群。
- 本身不会安装 kubelet、kubectl、网络插件。

### 安装

- 用 yum 安装：
  ```sh
  # 采用阿里的镜像源，因为谷歌的镜像源需要翻墙访问
  cat <<EOF > /etc/yum.repos.d/kubernetes.repo
  [kubernetes]
  name=Kubernetes
  baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64
  enabled=1
  gpgcheck=1
  repo_gpgcheck=1
  gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg
  EOF

  # 安装
  yum install -y kubeadm
  ```
  - 这会同时安装依赖的 kubelet、kubectl 。

### 命令

```sh
kubeadm
        version
        config        # 管理配置。这些配置会保存为一个名为 kubeadm-config 的 ConfigMap ，位于 kube-system 命名空间
          print       # 打印配置
            init-defaults
            join-defaults

        init          # 将本机初始化为主节点
        join          # 使本机连接到主节点，加入 k8s 集群
        reset         # 撤销 init、join 命令对本机的影响

        token         # 管理 token ，用于一个节点 join 主节点时的认证
          create
            --ttl     # 有效时长，过期则自动删除。默认为 24h
          delete <token>...
          list

```

### 部署

- 部署 k8s 时，主机需要满足的条件：
  - 至少 2v CPU、2G RAM 。
    - 空载时，主节点的全部进程占用 500M 内存，而工作节点的 kubelet 占用 100M 内存。
  - 禁用 Swap 分区。
  - 每个主机的 hostname、MAC 地址不同。
  - 安装 docker 引擎。
    - dockerd 采用的 Cgroup 驱动默认为 cgroupfs ，而 k8s 默认为 systemd 。因此需要修改 dockerd 的配置，并重启 dockerd ：
      ```json
      {
        "exec-opts": ["native.cgroupdriver=systemd"]
      }
      ```
  - 主机的防火墙开通了 k8s 所需的端口 6443、10250 。
  - 在集群的一个主机上安装 kubeadm、kubectl 。
  - 在集群的每个主机上安装 kubelet ，并启动：
    ```sh
    systemctl start  kubelet
    systemctl enable kubelet
    ```

- 下载 Docker 镜像：
  ```sh
  kubeadm config images pull --image-repository registry.aliyuncs.com/google_containers
  ```

- 在一个主机上执行以下命令，初始化为主节点：
  ```sh
  kubeadm init
              --config                            # 指定配置文件
              --kubernetes-version <string>       # k8s 版本。默认为最新的 stable 版本
              --image-repository registry.aliyuncs.com/google_containers  # 镜像仓库，默认为 k8s.gcr.io ，但它需要翻墙访问
              --node-name <name>                  # 指定当前节点名
              --pod-network-cidr 10.244.0.0/16    # Pod IP 的子网范围，也会被用于设置 cluster-cidr 。默认为空，不会分配 CIDR
              --service-cidr <string>             # Service IP 的子网范围，默认为 10.96.0.0/12
              --service-dns-domain <string>       # Service 的域名起点，默认为 cluster.local
  ```
  - 这会生成管理员的 kubeconfig 配置文件，拷贝它到默认路径：
    ```sh
    mkdir -p ~/.kube
    cp /etc/kubernetes/admin.conf ~/.kube/config
    ```
  - 默认给主节点设置了污点，不允许用作工作节点。可以移除污点：
    ```sh
    kubectl taint nodes --all node-role.kubernetes.io/master-
    ```

- 在其它主机上执行以下命令，加入 k8s 集群：
  ```sh
  kubeadm join 10.0.0.1:6443
        --token ****** --discovery-token-ca-cert-hash sha256:******   # 加入集群时需要使用 token 认证
        --control-plane     # 加入之后成为控制平面节点，默认是工作节点
  ```
  - 至少需要部署一个主节点和一个工作节点。
  - 如果部署多个主节点，则可实现 k8s 的高可用。
    - 此时需要给多个 kube-apiserver 实例创建一个负载均衡 IP 或 DNS ，用于访问。

- 启用一种 CNI 网络插件：
  ```sh
  curl https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml | kubectl apply -f -
  ```

## kubectl

：一个命令行工具，用于管理已部署的 k8s 集群。

### 安装

- 下载二进制文件：
  ```sh
  wget https://dl.k8s.io/release/v1.23.1/bin/linux/amd64/kubectl
  sudo install kubectl /usr/local/bin/

  kubectl completion bash > /etc/bash_completion.d/kubectl  # 启用 kubectl 命令补全，保存为 bash_completion 脚本
  ```

### 命令

```sh
kubectl
        cluster-info      # 显示集群信息
        version           # 显示 client 和 server 的版本
        config            # 访问 kubectl 自身的配置，即 kubeconfig
            view

        create            # 创建资源
            -f <file>     # 读取配置文件
        apply             # 更新某资源的配置文件，如果该资源不存在则自动创建
            -f <file>

        get <resource> [name]...    # 查看资源的信息。不指定 name 则显示这种资源的所有实例
                -o wide             # --output ，输出格式。默认显示列表格式的简介，wide 是显示更多列
                -o name             # 只显示名称
                -o json             # 显示 JSON 格式的详细配置
                -o yaml             # 显示 YAML 格式的详细配置
                --namespace default # 指定命名空间，只查看该命名空间中的资源
                -A                  # --all-namespaces ，查看所有命名空间
                -l key1=value1,...  # --selector ，通过标签进行筛选
                --kubeconfig ~/.kube/config # 指定用于连接集群的配置文件，其中配置了要连接的 apiserver 地址，以及使用的集群名、命名空间、账号

        describe <resource>         # 查看资源的信息，包括主要配置、event

        delete                      # 删除资源
            -f <file>               # 根据配置文件指定要删除的资源
            pods <name>...          # 删除指定的 pod
            deployments <name>...   # 删除指定的 deployment

        exec <pod> -- <command>     # 在 pod 中执行命令。注意在 command 之前加上分隔符 --
            -c <name>               # --container ，选择 pod 中的某个容器。默认选择第一个容器
            -it                     # 进入容器内终端

        expose                      # 创建 service ，映射端口

        logs <pod>                  # 查看日志
            -c <name>               # --container ，选择 pod 中的某个容器
            --all-containers        # 选择 pod 中的所有容器
            -f                      # --follow ，保持显示
            --tail 10               # 只显示最后几行。默认从头开始显示
            --timestamps            # 增加显示时间戳
            --since 1h              # 只显示最近一段时间的日志
            --since-time 2021-01-01T08:00:00Z # 只显示指定时刻开始的日志
```
- resource 类型可以是 nodes、pods、services 等。
  - 不区分单复数，比如 node 与 nodes 等价。
  - 支持通过逗号分隔符指定多个，比如 nodes,pods 。
- 例：
  ```sh
  kubectl create deployment nginx --image=nginx:1.20          # 部署一个应用
  kubectl exec nginx-6d777db949-5b77c -c nginx -it -- bash    # 进入容器内终端
  kubectl expose deployment nginx --port=80 --target-port=80  # 为应用 Nginx 创建 service ，默认为 ClusterIP 类型，并映射端口
  ```

## minikube

：一个命令行工具，用于部署单节点的 k8s 集群，常用于测试。
- 可以在本机部署多个 k8s 集群。每个 k8s 集群位于一个容器内，包含多个进程。

### 部署

1. 安装 docker
2. 下载 minikube ：
    ```sh
    wget https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
    sudo install minikube-linux-amd64 /usr/local/bin/
    ```

3. 以非 root 用户部署 k8s ：
    ```sh
    useradd leo
    usermod leo -G docker
    su - leo
    minikube start
    ```

3. 在本机安装 kubectl ，或使用 minikube 内置的 kubectl ：
    ```sh
    minikube kubectl -- get pods -A
    ```

### 命令

```sh
minikube
        start                             # 部署一个 k8s 集群
            -p <name>                     # --profile ，指定 k8s 集群的名称，默认为 minikube
            --driver docker               # 驱动，默认会自动选择
            --kubernetes-version v1.2.3   # k8s 版本。默认为最新的 stable 版本
        stop
        delete          # 删除当前 k8s 集群
            -p <name>   # 指定 k8s 集群的名称
            --all       # 删除所有 k8s 集群
        pause           # 暂停运行
        unpase

        profile         # 显示当前 k8s 集群的名称
            list        # 显示所有 k8s 集群
        status
```
