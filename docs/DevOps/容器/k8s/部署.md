# 部署

## minikube

：一个命令行工具，可以部署一个单节点的 k8s 集群，常用于测试。
- 可以在本机部署多个 k8s 集群。每个 k8s 集群位于一个容器内，包含多个进程。

### 部署

1. 安装 docker
2. 下载 minikube ：
    ```sh
    wget https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
    sudo install minikube-linux-amd64 /usr/local/bin/
    ```

3. 以非 root 用户部署 k8s ：
    ```sh
    useradd leo
    usermod leo -G docker
    su - leo
    minikube start
    ```

3. 在本机安装 kubectl ，或使用 minikube 内置的 kubectl ：
    ```sh
    minikube kubectl -- get pods -A
    ```

### 命令

```sh
minikube
        start                             # 部署一个 k8s 集群
            -p <name>                     # --profile ，指定 k8s 集群的名称，默认为 minikube
            --driver docker               # 选择驱动，默认会自动选择
            --kubernetes-version v1.2.3   # 选择版本。默认采用最新的 stable 版本
        stop
        delete          # 删除当前 k8s 集群
            -p <name>   # 指定 k8s 集群的名称
            --all       # 删除所有 k8s 集群
        pause           # 暂停运行
        unpase

        profile         # 显示当前 k8s 集群的名称
            list        # 显示所有 k8s 集群
        status
```
<!--
## kubeadm

：用于部署标准的 k8s -->

## kubectl

：k8s 集群的管理工具。
- 配置文件默认位于 `~/.kube/config` ，其中配置了要连接的 apiserver 地址，以及使用的集群名、命名空间、账号。

### 安装

```sh
VERSION=v1.23.1
wget https://dl.k8s.io/release/v1.23.1/bin/linux/amd64/kubectl
sudo install kubectl /usr/local/bin/

kubectl completion bash > /etc/bash_completion.d/kubectl  # 启用 kubectl 命令补全，保存为 bash_completion 脚本
```

### 命令

```sh
kubectl
        cluster-info      # 显示集群信息
        version           # 显示 client 和 server 的版本

        create            # 创建资源
            -f <file>     # 读取配置文件

        expose            # 创建 service ，映射端口

        get <resource> [name]...    # 读取资源。不指定 name 则显示这种资源的所有实例
                -o wide             # --output ，输出格式。默认显示成列表格式，wide 是显示更多列
                -o name             # 只显示名称
                -o json             # 显示成 JSON 格式
                -o yaml             # 显示成 YAML 格式
                --namespace default # 指定命名空间，只查看该命名空间中的资源
                -A                  # --all-namespaces ，查看所有命名空间
                -l key1=value1,...  # --selector ，通过标签进行筛选

        delete                      # 删除资源
            -f <file>               # 根据配置文件指定要删除的资源
            pods <name>...          # 删除指定的 pod 。如果所属的 deployment 没被删除，kubelet 会自动重新创建这种 pod
            deployments <name>...   # 删除指定的 deployment

        exec <pod> -- <command>     # 在 pod 中执行命令。注意在 command 之前加上分隔符 --
            -c <name>               # --container ，选择 pod 中的某个容器。默认选择第一个容器
            -it                     # 进入容器内终端

        logs <pod>                  # 查看日志
            -c <name>               # --container ，选择 pod 中的某个容器
            --all-containers        # 选择 pod 中的所有容器
            -f                      # --follow ，保持显示
            --tail 10               # 只显示最后几行。默认从头开始显示
            --timestamps            # 增加显示时间戳
            --since 1h              # 只显示最近一段时间的日志
            --since-time 2021-01-01T08:00:00Z # 只显示指定时刻开始的日志
```
- 资源类型可以是 nodes、pods、services 等。
  - 不区分单复数，比如 node 与 nodes 等价。
  - 支持通过逗号分隔符指定多个，比如 nodes,pods 。
- 例：
  ```sh
  kubectl create deployment nginx --image=nginx:1.20          # 部署一个应用
  kubectl exec nginx-7f8t967-q0f62 -c nginx -it -- bash       # 进入容器内终端
  kubectl expose deployment nginx --port=80 --target-port=80  # 为应用 Nginx 创建 service ，默认为 ClusterIP 类型，并映射端口
  ```
