# 权限

- k8s 组件提供了 Restful API ，但对于组件之间、用户对组件的请求，启用了以下安全措施：
  - 自签名的 SSL 证书
  - 身份认证策略
  - 鉴权策略

## 身份认证

- 客户端发送 HTTP 请求到 k8s 时，需要进行身份认证。
  - 如果一个 HTTP 请求未完成身份认证，则会被 k8s 视作 system:anonymous 用户，属于 system:unauthenticated 用户组。
    - 默认禁止匿名用户的请求，会返回响应 403: Forbidden

- k8s 支持多种身份认证方式：
  - SSL 客户端证书：用于验证客户端的身份，证书中的 CN 字段记录了用户名。
  - ServiceAccount Token ：需要客户端在 HTTP 请求头中加入 `Authorization: Bearer <token>` 。
  - Bootstrap Token ：用于部署 k8s 集群、新增节点。
  - 支持集群外的身份认证服务，比如 LDAP、Kerberos、OIDC 。

- k8s 将账户分为两类：
  - UserAccount ：供自然人使用，比如 kubectl 。
    - 不能通过 k8s API 创建。
  - ServiceAccount ：供应用程序使用。
    - UserAccount 是全局的，而 ServiceAccount 会被 namespace 隔离，可以划分更细的权限。
    - 创建一个 ServiceAccount 时，会自动创建并关联一个 secret ，包含了身份凭证，命名格式为 `<ServiceAccount>-token-<random_id>` 。
      - 如果删除该 secret ，则会自动创建一个新 id 的 secret 。
      - 如果删除该 ServiceAccount ，则会自动删除相应的 secret 。

### 示例

- 创建 Pod 时可以配置 ServiceAccount ：
  ```yml
  spec:
    serviceAccountName: default         # 该 Pod 采用的 ServiceAccount ，如果不存在则不能创建 Pod 。默认名为 default
    automountServiceAccountToken: true  # 是否自动将 ServiceAccount 关联的 secret 挂载到 Pod 的 /var/run/secrets/kubernetes.io/serviceaccount/ 目录下。默认为 true
  ```

- ServiceAccount 的配置示例：
  ```yml
  apiVersion: v1
  kind: ServiceAccount
  metadata:
    name: promethues
    namespace: default
  # secrets:            # 创建 ServiceAccount 之后会自动关联 secret
  # - name: promethues-token-zqltx
  ```

- ServiceAccount 的 secret 示例：
  ```yml
  apiVersion: v1
  data:
    ca.crt: ******      # CA 证书，用于验证服务器的身份
    namespace: ******
    token: ******       # 用于验证 ServiceAccount 的身份
  kind: Secret
  metadata:
    annotations:
      kubernetes.io/service-account.name: default
      kubernetes.io/service-account.uid: ******
    name: promethues-token-zqltx
    namespace: default
  type: kubernetes.io/service-account-token
  ```

## 客户端示例

- 使用 kubecbtl 作为客户端时，会从 kubeconfig 配置文件中获取 CA 证书、token ，从而连接 apiserver 。
- 可以用 kubectl 反向代理 apiserver ，此时发向 proxy 的 HTTP 请求不必采用 SSL、不需要 token 。
  ```sh
  kubectl proxy &
  curl 127.0.0.1:8001/
  ```

- 可以直接用 curl 命令访问 k8s ：
  ```sh
  TOKEN=`kubectl config view --raw | yq '.users[0].user.token'`         # 获取 token
  curl https://apiserver/metrics -H "Authorization: Bearer $TOKEN" -k   # 用 -k 选项跳过 SSL 认证
  ```
  <!-- ```sh
  TOKEN=`kubectl config view --raw | yq '.users[0].user.token'`
  # 获取 k8s 的 ca 证书
  kubectl config view --raw | grep certificate-authority-data | awk '{print $2}' | base64 -d > ca.crt
  curl https://apiserver/metrics -H "Authorization: Bearer $TOKEN" --cacert ca.crt
  ``` -->

