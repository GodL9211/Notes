# 简介

## 虚拟化技术

运行多个程序时，隔离它们的运行环境有利于管理。可采用以下方法进行隔离：
- 运行多个物理主机（成本最高，冗余最多）
- 在一个物理主机上创建多个虚机运行环境：
  - 创建虚拟机（成本比较高，冗余比较多）
  - 创建容器（成本最低，冗余最少）

### Hypervisor

：又称为 VMM（Virtual Machine Monitor ，虚拟机监视器）
- 原理：在计算机硬件与操作系统之间隔离出一个中间层，承载一个或多个操作系统。
- 虚拟机技术的缺点是：每创建一个虚拟机实例都要重新拷贝、安装一个完整的操作系统和运行环境，浪费时间。而且，发布应用软件时需要考虑不同环境的兼容问题，很麻烦。
- 常见的提供虚拟机服务的软件有：KVM、VirtualBox、Xen、VMwareWorkstation、Hyper-V（Windows 自带）。

### Container

：容器，是新一代的虚拟化技术。
- 原理：在应用软件与操作系统之间隔离出一个中间层。
- 容器使用镜像作为模板。镜像包含了程序及其依赖环境、配置信息，可以移植到不同平台运行，只需系统内核相同。
- 容器是比虚拟机轻量很多的虚拟化技术。通常将容器与虚拟机搭配使用，在虚拟机上再创建容器。

## Docker

：目前最流行的容器引擎。
- 基于 Go 语言，运行在 Linux 平台上。也有 Docker for Windows 版本，只能运行 windows 上的应用程序。
- 于 2013 年被 Docker 公司推出，掀起了容器技术的潮流。
- 以镜像（image）作为模板，创建容器（container）。
- [官方文档](https://docs.docker.com/engine/docker-overview/)

### 原理

- Docker 采用 C/S 工作模式。
  - 服务器作为宿主机上的守护进程运行，称为 docker daemon ，负责管理本机的容器、镜像。
  - 用户可以在宿主机上执行 docker 命令，作为客户端。这些命令会发送给服务器，由服务器执行。
- **Docker 容器是通过在宿主机上运行一些进程，模拟出一个虚拟机的运行环境。一个宿主机上可以同时运行多个 Docker 容器。**
- 通过 Linux namespace 隔离了各个容器的运行环境。
  - 隔离了进程、网络、文件系统，接近于独享一个虚拟机环境。
  - 没有隔离物理资源。例如：一个容器可能占用全部的 CPU 和内存；在容器内执行 top 命令会看到整个宿主机的资源。
  - 没有隔离 Linux 内核，容器内的进程可能通过内核漏洞溢出到宿主机上。
- 通过 Linux cgroups 限制了各个容器使用的 CPU、内存等资源。

使用 Docker 容器的推荐做法：
- 每个容器内应该只运行一个应用，尽量使得启动、停止该容器相当于启动、停止该应用，这样方便管理。
- 创建容器之后不要改动它，这样可以随时从镜像重新创建与其一致的容器。
- 创建无状态容器 —— 不将数据存储在容器内，因此可以随时关闭、重启容器，而不必担心数据丢失。
- 建议采用以下方案来存储容器的数据：
  - 挂载目录，将文件存储到容器外。
  - 将数据存储到容器外的数据库中。

### 安装

- 在 Centos 上安装：
    ```sh
    yum install yum-utils       # 安装 yum-config-manager
    yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo   # 添加 docker 的官方镜像源
    yum install docker-ce       # 下载 docker 社区版
    systemctl start docker      # 启动 docker daemon
    systemctl enable docker     # 使 docker 开机自启
    ```

- 在 ubuntu 上，可使用官方脚本自动安装：
    ```sh
    curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun
    ```

## 容器编排工具

当容器数量较多时，手动管理很麻烦，需要使用容器编排工具。常见的如下：
- Docker Compose ：由 Docker 公司推出，只能管理当前宿主机上的容器，不能管理服务器集群。
- Docker Swarm ：由 Docker 公司推出，可以管理多台宿主机上的容器。
- Mesos ：由 Apache 基金会推出。
- Kubernetes ：由 Google 公司推出，功能完善但也很复杂，目前最流行。
