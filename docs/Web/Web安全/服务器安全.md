# 服务器安全

## 关于前端

### XSS

：跨站脚本攻击（Cross Site Scripting）
- 原理：
  - 攻击者向网页源代码中注入恶意代码，然后被浏览器执行。
- 按注入方式分类：
  - 反射型：如果网页源代码会从 URL 中提取参数，则可以把恶意代码写入到 URL 中，诱使用户点击该链接，当用户跳转之后就被注入了恶意代码。
  - 存储型：将恶意代码作为表单内容（比如留言栏）上传到服务器。当其他用户在浏览器中查看该内容时，恶意代码就会被执行。
- 按攻击来源分类：
  - 恶意网站 B 与网站 A 不在同一个域名下。
  - 恶意网站 B 与网站 A 在同一个域名下，比如子应用。
- 对策：
  - 服务器不应该信任前端发来的数据，总是要检查该数据是否合法。

### CSRF

：跨站请求伪造（Cross-site request forgery）
- 原理：
  - 用户访问网站 A 时，一般会保持 session 或留下 cookies 。此时攻击者诱使用户点击网站 B 中的一个链接，该链接是向网站 A 发送一个 HTTP 请求，这样就能冒用用户的身份访问网站 A ，执行冒名操作。
- 对策：
  - 服务器检查每个 HTTP 请求的 Referer 字段，如果是跨站发来的请求就拒绝。
    - 不过这可能拦截从搜索引擎跳转过来的正常用户请求，也无法防御来自同一个域名的伪造请求。
  - 向网页源代码中加入一个随机 token ，当用户发出 HTTP 请求时都要带上该 token ，证明请求是从该网页发出的。
    - 例如在请求的 URL 中加入 token ：`http://www.test.com?csrftoken=123456`
    - 例如在 POST 表单里加入 token ：`<input type=”hidden” name=”csrftoken” value=”123456”/>`

## 关于后端

### DDoS

：分布式拒绝服务（Distributed Denial of Service）攻击
- 原理：
  - 攻击者从多个 IP 发出大量访问请求到服务器，使服务器处于忙碌状态，不能处理其他正常用户的访问请求，甚至导致服务器过载而崩溃。
- 攻击方法举例：
  - 

### 非法访问

- 原理：
  - 攻击者没有访问权限，但是通过服务器的某个漏洞非法访问了服务器资源。

- 对策：
  - 做渗透测试，修补漏洞。

### 冒名访问

- 原理：
  - 攻击者冒充某个用户的身份，获得其对服务器的访问权限。
  - 最严重的情况是，攻击者窃取到某个用户的用户名及密码，通过正常流程登录，难以判断出该用户是冒充的。
  
- 对策：
  - 保证正确鉴定每个访问者的身份，按身份给他们分配权限。（比如分成未登录者、普通用户、管理员）
  - 服务器可以根据登录 IP 异常、敏感操作等信息推测出登录的用户是否为本人，

### 越权访问

- 原理：
  - 攻击者作为一个正常用户登录之后，访问到该用户无权访问的资源。

- 对策：
  - 保证对所有资源（比如文件、端口）加上权限控制，收到访问请求时总是验证其访问权限。

### SQL 注入

- 原理：
  - 攻击者在客户端上传的表单数据中，插入恶意的 SQL 代码，等待被服务器误执行。

- 对策：
  - 服务器不能相信客户端或前端发来的数据，必须先检查其格式是否正确、是否包含非法字符。

## 关于密码

Web 服务器不应该直接储存用户的明文密码，而应该储存密码的哈希值，这样既可以检验用户输入的密码是否正确，还能防止 Web 服务器泄露用户的明文密码。

### 暴力破解密码

- 原理：
  - 当攻击者只知道用户的账号、不知道密码时，可能反复尝试用各种可能的密码登录，直到猜出用户的正确密码。
- 攻击方法举例：
  - 穷举法
    - 原理：生成所有可能的密码字符组合，逐个尝试。
    - 缺点：需要尝试的次数太多，耗时久。
  - 字典法
    - 原理：将人们常用的密码保存为一个字典，逐个尝试。
    - 缺点：需要用大量的存储空间来保存字典。

- 对策：
  - 当客户端连续三次输错密码之后就冻结其账号，禁止登录。在一段时间之后才解锁，或者只能通过更安全的身份验证方式登录，比如手机验证码。
  - 要求客户端在登录时输入验证码，使得攻击者难以用软件自动化尝试大量密码。

### 加密密码

- Web 服务器可以将用户明文密码的哈希值存储在数据库中，只要用户下次输入的密码的哈希值相同，就判断密码正确。
  - 这种情况下，即使攻击者入侵了 Web 服务器，得到数据库的访问权限，也只能看到密码的哈希值，无法知道对应的明文密码。
- 不过，通过以下攻击方法，依然可能暴力破解出哈希值对应的明文密码：
  - 穷举法
  - 字典法
    - 原理：事先记录人们常用的密码及其对应的哈希值。当目标哈希值与字典中某项匹配时，就可以知道对应的明文密码。
  - 彩虹表
    - 原理：
      - 先探明 Web 服务器采用的是哪种 Hash 算法，表示成函数 H() 。再拟定函数 R()，用于将哈希值 h 转换成另一个字符串 p 。然后选择一个字符串 p1 作为起点，依次计算出 h1=H(p1)、p2=R(h1)、h2=H(p2)、…… ，这样就得到了一条哈希链，记录其中的所有 p 。
      - 选取多个 p1 ，就可以算出多条哈希链，得到一个彩虹表。
      - 想破解某个哈希值 s 时，先计算 R(s) ，然后到彩虹表中寻找是否有与之相同的 p 值。假设 pn 的值与 R(s) 相同，则 s 对应的明文密码就是 pn-1 。
    - 使用彩虹表时比字典法少了一半的存储空间，又比穷举法快。
- 针对上述攻击方法，Web 服务器可采用以下对策：
  - 选用哈希值更长、加密更慢的 Hash 算法，增加暴力破解的试错成本。
  - 每次计算密码的哈希值时，加上一个随机的、无法预测的值，称为盐。
    - 这样即使攻击者知道了服务器采用的 Hash 算法，也不能事先准备一个破解字典。
    - 服务器应该将每个用户密码与盐值一起保存到数据库中。
  - 判断两个哈希值是否相同时，无论结果是 True 还是 False 甚至出错，都应该控制在相同的处理时长。
    - 如果使用一般的字符串比较方法（从左到右逐位比较，遇到某一位的字符不同时就返回 False），就可能被攻击者根据处理时长的微小差异逐位试出哈希值的每一位应该是什么值。
    - 使用异或运算就可以控制在相同的处理时长。比如：a ^ b == 0

## 关于通信

### 报文截获

- 原理：
  - 攻击者截取到客户端与服务器的通信报文，从其中窃取重要数据。

- 对策：
  - 使用 HTTP 协议通信会暴露报文内容，应该使用 HTTPS 协议进行加密通信。

### 报文丢失

：Web 服务器通信过程中的某些报文被丢失。可能是网络原因，也可能是遭到攻击者攻击。
