# 相关概念

## htpasswd

：Apache 提供的一个命令行工具，用于生成密码的哈希值。
- 安装：`yum install httpd-tools`
- 用法：
  ```sh
  htpasswd [file] [username] [password]
          -d                # 采用 CRYPT 算法
          -B                # 采用 BCRYPT 算法
          -m                # 采用 MD5 算法（默认）
          -s                # 采用 SHA-1 算法
          -2                # 采用 SHA-256 算法
          -5                # 采用 SHA-512 算法

          -c                # 创建加密文件，如果该文件已存在则会被覆盖
          -D  <username>    # 从文件中删除一个用户
          -v  <username>    # 验证一个用户的密码

          -b <password>     # 通过命令参数输入明文密码
          -i                # 从 stdin 读取密码
          -n                # 将加密结果输出到 stdout ，而不是文件
  ```
- 例：
  ```sh
  [root@Centos ~]# htpasswd -nb leo 123456            # 生成密码的哈希值
  leo:$apr1$mUtPb9mo$xCZajWWbJ3v42Bxu3WKFi/
  ```
  ```sh
  [root@Centos ~]# htpasswd -cb  ./passwd leo 123456  # 创建密码文件，添加一个用户及其密码
  Adding password for user leo
  [root@Centos ~]# htpasswd -b   ./passwd leo 1234    # 再添加一个用户及其密码。如果该用户名已存在，则会覆盖其密码
  Updating password for user leo
  [root@Centos ~]# htpasswd      ./passwd admin       # 再添加一个用户，默认通过终端提示输入密码
  New password:
  Re-type new password:
  Adding password for user admin
  [root@Centos ~]# cat passwd                         # 查看密码文件
  leo:$apr1$UjGpt1b7$aEIT6s.Kh/KMyjJ/z.men0
  admin:$apr1$cF7RBJdh$FGmchgxnb0gXV6GeY8PGH/
  [root@Centos ~]# htpasswd -D   ./passwd leo         # 删除一个用户
  Deleting password for user leo
  ```

## OpenSSL

：一个关于 SSL 的开源工具包。
- 例：生成 SSL 私钥和自签名证书：
  ```sh
  openssl
          req -x509           # 生成自签名的数字证书，采用 X.509 标准
          -days 365           # 证书的有效期
          -newkey rsa:2048    # 使用新生成的密钥
          -nodes              # no DES ，生成 key 文件时不加密
          -keyout cert.key    # 保存私钥文件
          -out cert.crt       # 保存证书文件
  ```
- 一般的浏览器不会承认自签名证书，会警告该网站不安全。

## ACME

- 大部分 CA 机构需要用户付费购买数字证书，而 Let's Encrypt 是一个免费的 CA 网站。

### Certbot

：一个命令行工具，用于基于 ACME 协议向 Let's Encrypt 申请、续订、撤销证书。
  - [官方文档](https://certbot.eff.org/docs/intro.html)
- 用户需要证明自己对域名拥有控制权，该过程称为 challenge ，主要有两种方式：
  - HTTP ：将域名绑定到一个网站，监听 80 端口，并在 URL `/.well-known/acme-challenge/` 下提供一个指定文件。
  - DNS ：添加一个 TXT 类型的 DNS 记录，将子域名 `_acme-challenge.<domain>` 解析到指定字符串。
    - 通配符域名只能通过 DNS 方式申请证书。
- 证书的有效期默认为 90 天。
  - 为了刷新有效期，可以重新创建证书，或续订。
  - 使用 DNS 插件时，会调用 DNS 服务器的 API ，从而自动续订。
  - 通过 --manual 方式申请的证书，不能自动续订，需要重新申请。
- 命令：
  ```sh
  certbot
          # 申请证书
          run                 # 默认执行该操作，会自动申请证书并安装
          certonly            # 只是获取证书，保存到本机，不会安装
          -d <domain>         # 指定要申请证书的域名。可以多次使用该选项，指定多个域名
          --email <xx>        # 填写申请人的 email

          # 证明域名控制权的几种方式
          --nginx             # 自动配置本机的 Nginx 服务器
          --standalone        # 运行一个简单的 HTTP 服务器。这需要暂时停止原网站
          --webroot -w /www/  # 指定网站的静态目录，自动创建验证文件
          --manual --preferred-challenges=dns  # 手动添加 DNS 记录

          # 关于 certbot 的配置
          --dry-run           # 向 CA 测试服务器发出请求，从而模拟执行命令
          --config-dir  /etc/letsencrypt
          --server      acme-v02.api.letsencrypt.org/directory

          # 其它操作
          certificates        # 列出本机存放的证书
          renew               # 续订有效期不足 30 天的所有证书
          revoke              # 撤销证书
          delete              # 删除本机存放的证书
  ```

- 例：
  1. 使用 Nginx 部署网站，在配置文件中加入一个路由：
      ```sh
      location /.well-known/acme-challenge/ {
          root  /certbot/www;
      }
      ```
  2. 运行 Certbot 的 Docker 镜像：
      ```sh
      docker run -it --rm \
          -v /certbot:/certbot \
          certbot/certbot:v1.20.0 \
          certonly --webroot -w /certbot/www -d xxx --email xxx --config-dir /certbot/etc
      ```
  3. 修改 Nginx 配置，使用证书，提供 HTTPS 服务：
      ```sh
      server {
          listen    443  ssl;

          ssl_certificate /certbot/etc/fullchain.pem;
          ssl_certificate_key /certbot/etc/privkey.pem;
      }
      ```
  4. 增加一个 crontab 定时任务，定期续订证书：
      ```sh
      0 1 1 * *  docker run -it --rm -v /certbot:/certbot certbot/certbot:v1.20.0 renew --config-dir /certbot/etc
      ```

### acme.sh

：一个 shell 脚本，功能比 certbot 更多。
- [GitHub](https://github.com/acmesh-official/acme.sh)
