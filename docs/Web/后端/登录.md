# 登录

Web 网站常见的登录方式：
- 账号密码登录
  - ：用户打开网站，输入账号密码登录。
  - 为了避免密码被暴力破解，通常发现一个用户连续多次登录失败之后，就禁止该用户登录一段时间。
- 凭证登录
  - ：网站通过 cookie 或 session 记录用户的身份信息，当用户重新访问网站时可以判断用户是否已登录。
- 单点登录（Single Sign On，SSO）
  - ：同一家公司下的不同网站共用一个身份验证系统，使得用户只需登录一次，然后通过一个凭证访问不同网站。
- 第三方登录
  - ：用户凭着其它网站的身份登录当前网站。

## OAuth

：一个用于第三方登录的 API 标准。
- 允许用户通过平台 A 的账号登录第三方应用，也允许第三方应用获取用户在平台 A 上的某些资源。
- 常用的版本是 OAuth2 ，它不兼容 OAuth1 。

### 角色划分

- 用户：要通过平台 A 的身份验证登录 app 。
- 第三方应用：简称为 app 。
- 资源服务器：存储着用户在平台 A 上的资源。
- 授权服务器：完成身份认证之后，返回一个 token（访问令牌）给 app ，允许 app 拿着这个 token 发出 HTTP 请求到资源服务器，获取用户在平台 A 上的某些资源。
  - 平台 A 的资源服务器、授权服务器可能是同一台服务器。

### 工作模式

- 授权码模式
  - ：app 先向授权服务器申请 code（授权码），拼接出申请 token 的登录 URL 。
  - 由平台 A 完成统一的身份认证，避免了用户在每个网站上创建账号的麻烦。
  - 由平台 A 负责实际的身份验证，第三方应用不会知道用户的真实密码，因此这种模式最安全。
- 简化模式
  - ：app 直接向授权服务器申请 token 。当用户从授权服务器跳转回来时，token 会被放在 URL 中，容易泄露。
  - 适用于 app 只有网页，没有后端服务器的情况，比如手机应用。
- 密码模式
  - ：用户将自己的账号密码告诉 app ，让 app 拿着账号密码去获取 token 。这样 app 有权访问用户的所有资源。
- 客户端模式
  - ：授权服务器收到 app 的请求时直接返回 token ，不需要身份验证。

### 授权码模式

工作流程：
1. 用户在 app 的网页上点击 “以其它方式登录” 的链接。
2. app 构造出平台 A 的 OAuth 登录 URL ，让用户 302 重定向到它（采用 GET 请求）。
    - app 要在登录 URL 的请求字符串中加入以下参数：
      ```sh
      client_id       # app 在平台 A 上注册的 id
      redirect_uri    # app 的回调 URL
      response_type   # 表示希望服务器返回的值类型。必须设置为  "code"
      scope           # 表示 app 请求授权的范围
      state           # 一个针对该请求的随机数，用于防止 CSRF 攻击。
      ```
    - 例如：`…….com/oauth/authorize?client_id=……&redirect_uri=……&response_type=code`
    - app 需要事先平台 A 上注册，设置自己的 redirect_uri ，被分配 client_id、client_secret 。
3. 用户在平台 A 的页面上，同意授权给 app 。
    - 平台 A 要验证用户的身份（可能要让用户通过账号密码或其它方式完成登录），然后验证登录 URL 中是否包含了必须参数、这些参数是否有效，最后循环用户是否同意授权给 app 。
    - 如果授权失败或出错，平台 A 应该在自己的网页上告诉用户。
4. 平台 A 构造出 app 的 redirect_uri ，让用户 302 重定向到它（采用 GET 请求）。
    - 平台 A 要在 redirect_uri 的请求字符串中加入以下参数：
      ```sh
      code            # 一个根据 client_id 和 redirect_uri 生成的随机值
      state           # 原样返回 app 的 state
      ```
    - code 应该在几分钟之内过期，减少泄漏的风险。
    - code 是一次性的，如果有 app 拿着用过的 code 来请求平台 A 发放 token ，平台 A 应该拒绝该请求，并撤销基于该 code 发放的 token 。
    - app 应该检查该 state 参数是否与自己发送的相同（可以事先保存在用户的 session 中）。
5. 当用户重定向回到 app 时，app 从 redirect_uri 中解析出 code ，向平台 A 请求 token 。
    - app 的后端服务器发出 POST 报文到平台 A ，请求获取 token 。报文 body 中应该采用 application/x-www-form-urlencoded 格式，包含以下参数：
      ```sh
      client_id
      client_secret
      redirect_uri
      code            # 填入 app 从 redirect_uri 中解析出的 code
      grant_type      # 表示授权模式。必须设置为 "authorization_code"
      ```
    - 平台 A 的响应报文 body 中包含以下参数：
      ```sh
      access_token    # 访问令牌
      expires_in      # token 的过期时间
      refresh_token   # 当 access_token 过期之后，用 refresh_token 来请求新的 access_token
      token_type      # token 的类型，通常为 “bearer”
      scope           # token 的授权范围
      ```
    - 如果 refresh_token 也过期了，就需要用户重新授权。
    - 有的平台只有 access_token ，没有 refresh_token 。
6. app 收到 token ，拿着它向平台 A 请求用户的身份信息（比如用户名）。
    - app 拥有 token 之后，就有权限调用平台 A 的一些 API 了。
7. app 同意用户登录，将用户重定向到自己的业务页面。


## LDAP

：轻型目录访问协议（Lightweight Directory Access Protocol）
- 一种管理树形结构数据的网络协议，基于 TCP 通信。
- 采用 C/S 架构。
  - server 负责存储数据。
  - client 可以访问 server ，对数据进行增删查改。
- 通常用 LDAP 按组织结构存储大量用户的信息，用于身份认证。
  - 大部分通用软件都支持连接 LDAP 服务器。

### 原理

- LDAP 服务器上可以创建多个目录视图（View），在其中按树形结构存储数据。
  - 与 SQL 型数据相比，树形结构的查询速度很快，但写入速度较慢。
  - 目录中的数据可以导出到 LDIF（LDAP Interchange Format） 格式的文本文件中，也可以再导入。

- LDAP 存储的每条数据称为条目（Entry）。
  - 每个条目拥有一个唯一的标识名（Distinguished Name，DN），它由该条目的保存路径上各个节点的名称组合而成，相当于绝对路径。
  - Relative DN ：父节点的 DN ，相当于相对路径。
  - Base DN ：目录中的根节点。
  - DN 中不能包含 `,=+<>;"` 等特殊字符，需要用 `\` 转义。

例如“uid=yinzhengjie,ou=中国检科院,dc=caiq,dc=org”




- 每个条目可以拥有任意个属性（Attribute），用于记录该条目的各种信息。
  - 每个属性有且仅有一个属性类型（AttributeType），定义了属性值（Value）的格式、语法。
  - 例如：

    属性                      | 别名   | 语法              | 描述           | 取值举例
    -|-|-|-|-
    User Id                   | uid   | Directory String  | 用户ID         | LeoHsiao
    commonName                | cn    | Directory String  | 姓名           | LeoHsiao
    surname                   | sn    | Directory String  | 姓             | Leo
    organization              | o     | Directory String  | 组织、公司名称  | test
    organizationalUnitName    | ou    | Directory String  | 单位、部门名称  | test
    Domain Component          | DC    | Directory String  | 域名中的部分    | com
    telephoneNumber           |       | Telephone Number  | 电话号码        | 123456

- 对象类（ObjectClass）
  - LDAP 内置了一些常见的对象类型，可以通过继承它们来定义条目或对象类。
    - 比如人员（person）拥有姓（sn）、名（cn）、电话(telephoneNumber)、密码(userPassword)等属性。
  - 对象类分为三大类：
    - 结构类型（Structural）：最基本的父类，每个条目必须继承且只能继承一个。
    - 抽象类型(Abstract)：不能被直接继承。
    - 辅助类型（Auxiliary）：每个条目可以继承任意个。
  - 对象类的属性分为两类：
    - 必要属性（Required）：必须被继承。
    - 可选属性（Optional）：不一定被继承。
  - 如果两个 ObjectClass 拥有某个相同的属性，则只会继承一次该属性。
  - 每个目录拥有一个 Schema ，记录了该目录用到的所有 ObjectClass ，用于在新增条目时检查条目是否合法。

### 部署

1. 运行 Docker 镜像：
    ```sh
    docker run -d \
          -p 389:389 -p 636:636 \
          -v /opt/ldap/data:/var/lib/ldap \              # 挂载存储目录
          -v /opt/ldap/conf:/etc/ldap/slapd.d \  # 挂载配置目录
          --name openldap osixia/openldap:1.4.0
    ```

```sh
docker exec -it openldap bash
ldapsearch -x -H ldap://localhost -b dc=example,dc=org -D "cn=admin,dc=example,dc=org" -w admin
```
