# 登录

Web网站常见的登录方式：
- 账号密码登录：用户打开网站，输入账号密码登录。
- 自动登录：网站通过cookie或session保存用户的信息，当用户重新访问网站时可以判断用户是否已登录。
- 单点登录：同一家公司下的不同网站共用一个登录验证的平台，用户可使用同样的账号密码或cookie登录。
- 第三方登录：用户凭着其它网站的身份登录当前网站。

## OAuth

：一个用于第三方登录的API标准。
- 允许用户通过平台A的账号登录第三方应用，也允许第三方应用获取用户在平台A上的某些资源。
- 常用的版本是OAuth2，它不兼容OAuth1。
- OAuth涉及到四种角色：
  - 用户：要通过平台A的身份验证登录app。
  - 第三方应用：简称为app。
  - 资源服务器：存储着用户在平台A上的资源。
  - 授权服务器：完成身份认证之后，返回一个token（访问令牌）给app，允许app拿着这个token发出HTTP请求到资源服务器，获取用户在平台A上的某些资源。
    - 平台A的资源服务器、授权服务器可能是同一台服务器。
- OAuth有四种模式：
  - 授权码模式
    - ：app先向授权服务器申请code（授权码），拼接出申请token 的登录URL。
    - 由平台A完成统一的身份认证，避免了用户在每个网站上创建账号的麻烦。
    - 由平台A负责实际的身份验证，第三方应用不会知道用户的真实密码，因此这种模式最安全。
  - 简化模式
    - ：app直接向授权服务器申请token。当用户从授权服务器跳转回来时，token会被放在URL中，容易泄露。
    - 适用于app只有网页，没有后端服务器的情况，比如手机应用。
  - 密码模式
    - ：用户将自己的账号密码告诉app，让app拿着账号密码去获取token。这样app有权访问用户的所有资源。
  - 客户端模式
    - ：授权服务器收到app的请求时直接返回token，不需要身份验证。

### 授权码模式

工作流程：
1. 用户在app的网页上点击“以其它方式登录”的链接。
2. app构造出平台A的OAuth登录URL，让用户302重定向到它（采用GET请求）。
    - app要在登录URL的请求字符串中加入以下参数：
      - client_id  ：app在平台A上注册的id。
      - redirect_uri  ：app的回调URL。
      - response_type：表示希望服务器返回的值类型。必须设置为  "code"。
      - scope    ：表示app请求授权的范围。
      - state    ：一个针对该请求的随机数，用于防止CSRF攻击。平台A应该在app的redirect_url中返回它，app应该对它进行验证（可以保存在用户的session中）。
    - 例如：…….com/oauth/authorize?client_id=……&redirect_uri=……&response_type=code
    - app需要事先平台A上注册，设置自己的redirect_uri，被分配client_id、client_secret。
3. 用户在平台A的页面上，同意授权给app。
    - 平台A要验证用户的身份（可能要让用户通过账号密码或其它方式完成登录），然后验证登录URL中是否包含了必须参数、这些参数是否有效，最后循环用户是否同意授权给app。
    - 如果授权失败或出错，平台A应该在自己的网页上告诉用户。
4. 平台A构造出app的回调URL，让用户302重定向到它（采用GET请求）。
    - 平台A要在回调URL的请求字符串中加入以下参数：
      - code：一个根据client_id和redirect_uri生成的随机值。
      - state：原样返回app的state值。
    - code应该在几分钟之内过期，减少泄漏的风险。
    - code是一次性的，如果有app拿着用过的code来请求平台A发放token，平台A应该拒绝该请求，并撤销基于该code发放的token。
5. 当用户重定向回到app时，app从回调URL中解析出code，向平台A请求token。
    - app的后端服务器发出POST报文到平台A，请求获取token。报文body中应该采用application/x-www-form-urlencoded格式，包含以下参数：
      - client_id
      - client_secret
      - redirect_uri
      - code：填入app从回调URL中解析出的code。
      - grant_type：表示授权模式。必须设置为"authorization_code"。
    - 平台A的响应报文body中包含以下参数：
      - access_token：访问令牌。
      - expires_in：token的过期时间。
      - refresh_token：当access_token过期之后，用refresh_token来请求新的access_token。
      - token_type：token的类型，通常为“bearer”。
      - scope：token的授权范围。
    - 如果refresh_token也过期了，就需要用户重新授权。
    - 有的平台只有access_token，没有refresh_token。
6. app收到token，拿着它向平台A请求用户的身份信息（比如用户名）。
    - app拥有token之后，就有权限调用平台A的一些API了。
7. app同意用户登录，让用户重定向到自己的业务页面。
