# ETH

：以太币（Ether），一种数字货币，由以太坊（Ethereum）区块链发行。
- [官方文档](https://ethereum.org/en/developers/docs/)
- 与 BTC 相比，以太坊提供了一种图灵完备的脚本语言，允许用户编写去中心化程序，部署在区块链中。

## EVM

- 以太坊虚拟机 (EVM)：由以太坊所有节点共同维护的一个虚拟机，负责执行操作指令，比如交易、部署合约、调用合约等。
  - 以太坊区块链负责保存 EVM 的当前状态，比如所有账户的余额。而 EVM 会读写区块链的数据。

- EVM 的操作指令像汇编语言，示例：
  ```sh
  ADD a b     # 耗费 3 gas ，用于计算两个数之和
  MUL a b     # 耗费 5 gas ，用于计算两个数的乘积
  SUB a b     # 耗费 3 gas ，用于计算两个数之差，即 a - b
  DIV a b     # 耗费 5 gas ，用于计算两个数的整除

  CALL        # 耗费 0 gas ，用于调用一个账户 address
  STOP        # 耗费 0 gas ，用于停止执行
  RETURN      # 耗费 0 gas ，用于停止执行并返回输出数据
  ```
  - [官方文档](https://www.evm.codes/)

- 多次让 EVM 执行请求时，可能会重复使用一些指令。可以将这些指令上传到 EVM ，供以后调用，称为智能合约。
  - 智能合约通常采用 Solidity 语言开发。
  - 智能合约保存在区块链中，对所有人公开可见、可调用。
  - 一些开发人员将程序的关键代码片段制作成智能合约，从而实现去中心化程序（Decentralized Application ，DAPP）。


<!-- 一个智能合约被编译后就是一段 EVM 指令，将它部署在以太坊的区块链时，会根据部署者的地址和该地址的 nonce 分配一个合约地址，合约地址和账户地址的格式是没有区别的，但合约地址没有私钥，也就没有人能直接操作该地址的合约数据。要调用合约，唯一的方法是调用合约的公共函数。 -->

## 区块

- 以太坊基于 MPT（Merkle Patricia Trie） 数据结构记录当前区块链的全部状态数据。
  - 每个叶子节点记录一个账户的余额，每次交易时会更新账户的余额。
    - BTC 需要统计所有历史交易的输入、输出，才能计算出所有账户的 UTXO 即余额。而以太坊直接记录了所有账户的余额。
  - 目前以太坊 MPT 有几亿个节点，体积很大，因此：
    - 打包一个新区块时，只需增量更新 MPT ，不必全量更新。
    - 每个区块会记录当前 MPT 的根哈希（state_root）。
    - 以太坊客户端不必将整个 MPT 载入内存，而是根据节点路径从磁盘读取子树。

- 对于谁有权生成新区块，以太坊早期采用 PoW 共识算法，后来转向了 PoS 共识算法。
  - PoS 的主要原理：
    - 一些节点通过智能合约质押（staking） 32 个 ETH ，获得成为验证者（validator）的资格，负责投票验证新区块是否有效。
      - 如果行为不诚实，或者没有准时验证新区块，则质押的 ETH 销毁一部分，作为惩罚。
      - 如果工作称职，则质押的 ETH 少量增加，作为奖励。
    - 每个出块周期（slot），随机选取一个验证者担任提议者（proposer），有权打包新区块，然后广播给其它节点。
  - 与 PoW 相比，PoS 的优点：
    - 去掉了工作量成本，大幅降低了挖矿消耗的计算机硬件、电能，不过矿工打包新区块的奖励也很少。
    - 大幅降低了挖矿的门槛，避免大公司控制大量矿工算力，导致投票权中心化。不过拥有更多 ETH 的用户，可以控制更多验证者，也会导致投票权中心化。
    - 出块周期固定为 10s ，不像 BTC 会因为挖矿难度波动而改变出块时间。
    - 对 PoS 进行 51% 攻击，需要质押超过 50% 的 ETH ，成本几乎不可能实现，且攻击一次之后就会损失质押的 ETH 。

- 关于 ETH 币：
  - 矿工打包区块时，会产生少量的 ETH 作为奖励，
  - ETH 总量没有上限。
  - ETH 数量的最小单位为 Wei ，1 ETH = 10^18 Wei 。

## 节点

- 一些主机运行以太坊客户端，根据以太坊协议相互通信，组成了以太坊网络。这些主机称为以太坊节点。
  - 每个节点会存储区块链数据的一个副本，但 EVM 在以太网中只存在一个实例。
  - 通常人们使用的是以太坊主网络，但还有测试网络等其它网络。每个网络中存在一条独立的区块链。

- 节点分类：
  - 全节点（Full Node）
    - ：存储了全部区块的完整数据。
    - 能独立验证区块数据，因此能担任矿工、验证者.
  - 轻节点（Light Node）
    - ：存储了全部区块的 header ，需要获取区块 body 时，再从全节点下载。
      - 可根据自己存储的 header ，验证全节点提供的各个区块是否正确。
    - 不能独立验证区块数据，因此不能担任矿工、验证者.
  - 归档节点（Archive Node）
    - ：存储了全部区块的完整数据，以及每个区块时刻的 EVM 状态。

- 启动以太坊客户端时，需要从网络获取最新的 EVM 数据。有多种同步方式：
  - 完全同步（full sync）
    - ：下载全部区块的完整数据，然后从创世区块开始依次执行各个区块的每一笔交易，最终得到最新的 EVM 数据。
    - 该同步方式的安全性最高，但是耗时为几周，占用几十 TB 的磁盘。
  - 快速同步（fast sync）
    - ：下载全部区块的完整数据，然后根据每个区块的 header 验证区块的 body 是否正确。最近的 64 个区块则按 full sync 方式同步。
    - 耗时为几十小时。
  - 快照同步（snap sync）
    - ：下载最近的一个 MPT 快照，下载 MPT 叶子节点的数据并验证，然后在本机生成 MPT 的非叶子节点。
      - 与之相比，fast sync 会下载 MPT 所有节点的数据并验证。
    - 该同步方式由 Geth 团队发明，耗时为几小时，占用几百 GB 的磁盘。
  - 轻同步（light sync）
    - ：下载最近一些区块的完整数据，随机挑一些区块验证其 header、body 。
    - 耗时为几分钟，安全性最低。
    - 目前以太坊网络中支持 light sync 的服务器很少，因为全节点缺乏激励做这事。

- 以太坊客户端主要有两层功能：
  - 执行客户端（execution client）
    - ：ETH v1 原有的客户端，负责保存当前 EVM 的数据、监听网络中广播的新交易并放到 EVM 中执行。
  - 共识客户端（consensus client）
    - ：ETH v2 新增的客户端，担任信标节点，根据 PoS 算法验证执行层的数据是否有效。
    - 一个执行客户端启动时，依赖一个共识客户端。

- 相关概念：
  - <https://etherscan.io/nodetracker> ：查看全球的节点统计。
  - [Geth](https://github.com/ethereum/go-ethereum) ：最流行的一个以太坊执行客户端，采用 Golang 开发。
  - [Prysm](https://github.com/prysmaticlabs/prysm) ：一个以太坊共识客户端，采用 Golang 开发。

## 账户

- 以太坊的账户地址分为两种：
  - 外部账户（Externally-owned）
    - ：供普通用户使用，由私钥控制。
    - 示例：
      ```sh
      0xcf4ec3c95d568ac6fc8413d163e645d3375639bbec5e90f74aa21d2e8eb38c20  # 私钥
      0xfd5aC7632B2044D8D3F5C7ce08b9d69e8b93493e                          # 公钥
      ```
  - 合约账户（Contract）
    - ：部署一个智能合约时会创建一个合约账户。地址为 40 位长度的十六进制数，没有私钥。
    - 两种账户都能交易代币、使用智能合约。
    - 创建外部账户是免费的，而创建合约账户需要付费。

- 生成外部账户的步骤：
  1. 根据椭圆曲线 secp256k1 生成一对公钥、私钥，长度都为 32 bytes 。
  2. 将私钥表示成 64 位长度的十六进制数。
  3. 计算公钥的 keccak256 哈希值，取最后 20 bytes ，表示成 40 位长度的十六进制数，作为账户地址。

- MPT 中，每个账户会记录以下数据：
  ```sh
  nonce         # 账户已执行的交易次数，从 0 开始递增
  balance       # 账户持有的 ETH 余额，单位为 Wei

  codeHash      # 合约账户的代码哈希值，用于从 EVM 数据库中获取智能合约。外部账户的该字段为空
  storageRoot   # 合约账户的存储哈希值，用于从 EVM 数据库中获取存储数据。外部账户的该字段为空
  ```

## 交易

- 用户想让 EVM 执行指令时，需要广播交易（transaction）请求，等待矿工将该指令打包到新区块。
- 常见的交易类型：
  - 常规交易：在账户之间转账 ETH 。
  - 部署合约
  - 调用合约：发送一些 ETH 和输入参数到合约账户，执行合约代码。
- 每个请求需要消耗 EVM 的一些计算资源，称为 Gas 。
  - 以太坊网络的负载时大时小，因此同样的交易需要消耗的 Gas 数量经常变化。
- 用户请求交易时，需要付出一些 ETH 费用。分为两部分：
  - Base Fee（基础费用）
    - ：为了避免请求对 EVM 的负载过大，用户必须根据消耗的 Gas 量燃烧一些 ETH ，即永久销毁。
  - Priority Fee（优先费用）
    - ：付给矿工的小费，可以为 0 。给得越多，越容易被矿工打包。

- 用户请求交易时，需要声明以下信息：
  ```sh
  From          # 从哪个账户发送 ETH
  To            # 发送 ETH 到哪个账户
  value         # 发送的 ETH 数量，单位为 Wei
  data          # 自定义的数据，默认为空。常用于保存调用合约时的输入参数
  signature     # 用户根据私钥创建的签名，用于授权该交易

  gasLimit      # 该交易最多消耗多少单位的 Gas 。常规交易默认为 21000 ，调用合约可能需要更多 Gas 。
  maxFeePerGas  # Gas 最大单价。对于每单位 Gas ，用户最多愿意付出多少 Gwei
  maxPriorityFeePerGas  # 每单位 Gas 中，最多愿意付出多少 Gwei 作为矿工的小费
  gasPrice      # 每单位 Gas 等于多少 Gwei ，1 ETH = 10^9 Gwei
  ```
  - 用户请求交易之前需要估计最多付费：
    ```sh
    maxFeePerGas = (baseFeePerGas + maxPriorityFeePerGas)
    maxFee = maxFeePerGas * gasLimit
    ```
    实际付费为：
    ```sh
    FeePerGas = (baseFeePerGas + PriorityFeePerGas)
    Fee = FeePerGas * gasUsed
    ```
  - 如果实际付费 Fee 少于最多付费 maxFee ，则差额会退款。
  - 如果交易需要消耗的 Gas 超过 gasLimit ，则消耗完 gasLimit 之后交易会执行失败，不会退款。

- 每个交易打包到区块之后，会产生一个回执（Recipt），表示该交易的结果。包含以下信息：
  ```sh
  status    # 交易是否成功。取值 1、0 分别表示成功、失败。比如账户余额不足时会交易失败
  gasUsed   # 实际消耗多少 Gas
  txHash    # 交易的哈希值

  txHash    # 交易的哈希值
  ```

## 相关概念

- ERC-20（Ethereum Request for Comments 20）代币标准
  - 以太坊允许创建独特且不可分割的代币，称为不可替代代币(NFT)
- 去中心化金融（DeFi）


## 相关历史

- 2013 年，俄罗斯程序员 Vitalik Buterin 等人开始开发以太坊项目。
  - BTC 的最初目的是提供一种去中心化的货币，实现价值存储功能。而以太坊的最初目的是实现去中心化程序。
- 2015 年，以太坊主网上线。

- 20016 年 6 月，以太坊开始了 The DAO 项目，众筹了大量 ETH ，但是被黑客通过漏洞转走了 360 万个 ETH 。
  - 事发后，以太坊开发者的解决方案是，通过硬分叉将区块链回滚到事发之前的状态，从而回滚交易。
  - 一些社区用户反对该硬分叉，称它违反了区块链的不可篡改特性，因此继续使用原链，称为以太坊经典（ETC）。

- 2018 年 1 月，ETH 成为市值第二大的数字货币，仅次于 BTC 。
- 2019 年 2 月，以太坊实施一次升级，代号为君士坦丁堡。
- 2021 年 8 月，以太坊实施一次升级，代号为伦敦。实施了 EIP1559 提案。
  - 之前，用户交易付出的 Gas 会全部交给矿工。之后，用户交易付出的 Gas 分为 Base Fee、Priority Fee 两部分。
    - 当一个新区块的 ETH 奖励少于燃烧的 Base Fee 时，ETH 的流通总量就会变少。
    - baseFeePerGas 是以太坊根据最近的网络负载计算出来的，因此用户只需要考虑 PriorityFeePerGas ，更容易预测交易需要付出的 Gas 。
  - 之前，区块有固定的容量限制。之后，取消区块的容量限制，改为限制 Gas 总量，从而方便打包大体积的请求。
    - 每个区块的所有交易消耗的 Gas 总量称为 Gas Used 。
    - 一般情况下，每个区块期望的 Gas Used 为 15,000,000 ，称为 Gas Target 。最多消耗的量是其 2 倍。
    - 如果上一个区块的 Gas Used 高于 Gas Target ，则增加新区块的 baseFeePerGas ，反之减少 baseFeePerGas 。

- 以太坊计划升级到 v2.0 ，大幅提高网络吞吐量，分为 3 个阶段：
  1. 2020 年 12 月部署一条采用 PoS 的区块链，称为信标链。
  2. 2022 年，将信标链与原链合并
  3. 分片链，将网络分散到 64 条链上
  - 难度炸弹：从某个区块开始，指数级增加 PoW 挖矿的难度，逼迫矿工从 PoW 挖矿转向 PoS 挖矿。

