# 简介

## 分布式系统

：是指将一个软件系统的各个进程分别部署在多个主机上。
- 小型的软件系统通常只部署在一台计算机上，属于集中式系统。而大型的软件系统通常部署成分布式系统，从而提高性能。
- 优点：
  - 便于横向增加系统节点，提高系统容量、性能，比如处理高并发流量。
  - 可以为一个软件应用运行多个实例，提高服务可用性。
  - 可以为一个数据存储多个副本，提高数据安全性。
- 难点：
  - 系统规模变大、结构变复杂，维护麻烦。
  - 比集中式系统多用了一些技术和组件，比如负载均衡、消息队列、分布式锁、分布式数据库、分布式文件系统。

## 一致性

：Consistency ，指系统中不同节点拥有的数据副本一致（通常还应该是最新的数据）。
- 数据一致的节点越多，则称为一致性越强。
- 各个节点可能因为拥有的数据副本不一致，而作出不同的决策，发生脑裂（brain split）。
- 有的分布式系统允许节点不一致，只要在客户端读取数据之前实现一致性。

### 常见算法

- Paxos
  - 一个节点作为 Proposer 发出某个提议，其它节点作为 Acceptor 参与决策。
  - 主要采用多数派（Majority）策略，即一个决策只要得到大多数节点认可，就会通过。
  - 假设系统包含 N 个节点，则最多容许 `N/2 - 1` 个节点同时故障，否则就不能完成决策。

- Raft
  - 系统中有且仅有一个节点作为 Leader ，有权作出决策。其它节点作为 Follower ，只能跟随决策。
  - 如果 Leader 故障，则其它节点作为 Candidate ，选举一个节点担任新 Leader 。
  - 每选出一个 Leader ，就开始一次任期（Term）。

- Bully
  - 与 Raft 类似。如果 Leader 节点故障，则由 ID 最大的一个节点担任新 Leader 。

## 可用性

：Availability ，指客户端发出请求时，能在正常时间内收到响应。该响应不能是错误的，但可以不是最新的数据。
- 如果服务的响应时间较长，甚至服务中断，则称为可用性低。
- 采用负载均衡、健康检查等方式可以实现服务的高可用性。

### 单点故障

：Single Point of Failure ，系统中单个模块或主机发生故障，导致整个系统的服务不可用。

### 负载均衡

：Load Balance ，将业务服务器部署多个实例，并提供一个代理服务器所有用户访问，该服务器会将用户的访问请求按某种算法均衡地转发给各个业务服务器处理。

相关工具：
- LVS（Linux Virtual Server）
  - ：Linux 的一个内核模块，可以通过转发 TCP/UDP 报文，实现第四层的负载均衡。
  - LVS 的代理性能最好，但是使用时最麻烦。
- F5
  - ：一种通过硬件实现负载均衡的服务器，基于 BIG-IP 协议。
- HAProxy
  - ：一个代理程序，可以实现第四层的 TCP 代理、第七层的 HTTP 代理。
- Nginx
  - ：一个 Web 前端服务器，可以实现第四层的 TCP 代理、第七层的 HTTP 代理。

### 健康检查

：Health Check ，通过软件检查集群中各个服务器的状态，自动发现故障的服务器。
- 发现故障节点之后，需要及时将它下线，或修复，或重新部署。

相关工具：
- keepalived ：一个软件，可以对集群的各个服务器进行健康检查、自动去除故障的服务器。
  - 在集群的每个服务器上部署一份，相互之间通过 VRRP（Virtual Router Redundancy Protocol ，虚拟路由冗余协议）通信，实现路由的高可用。
  - 工作在第三层时，是基于 ICMP 协议检查服务器是否在线。
  - 工作在第四层时，是基于 TCP 协议检查服务器的端口是否开通。
  - 工作在第七层时，是基于 HTTP 协议检查服务器是否正常工作。

## 分区容错性

：Partition tolerance ，指系统出现网络分区时，能否继续提供服务。
- 如果任意两个节点之间不能在指定时间内将数据同步一致（比如网络延迟较大、节点故障），则视作网络中断，出现了网络分区。

## CAP 定理

：一种流行的理论，认为在分布式系统中，一致性（C）、可用性（A）、分区容错性（P） 三种性能通常不能同时满足，最多满足两种。
- 原理：假设分布式系统中存在两个节点 N1、N2 ，两者的网络通信必然存在一定延迟。先在 N1 处写入数据 D ，然后在 N2 处读取数据 D 。此时：
  - 如果 N2 等同步 N1 的数据之后再返回响应，则满足了 C ，但不满足 A 。
  - 如果 N2 不同步 N1 的数据就返回响应，则必然是错误的响应，满足了 A ，但不满足 C 。
  - 如果 N1 或 N2 因为网络分区而不能提供服务，则满足了 C ，但不满足 A、P 。

## Etcd

：一个分布式的键值对数据库。
- 由 CoreOS 团队于 2013 年开源，基于 Golang 开发。
- 采用 Raft 算法实现分布式系统的一致性。
