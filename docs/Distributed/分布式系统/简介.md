# 简介

## 分布式系统

：是指将一个软件系统的各个进程分别部署不同主机上。
- 小型的软件系统通常只部署在一台计算机上，属于集中式系统。而大型的软件系统通常部署成分布式系统，从而提高性能。
- 优点：
  - 便于横向增加系统节点，提高系统容量、性能，比如处理高并发流量。
  - 可以将同一个应用运行多个实例，一个实例挂掉了就用其它实例，实现服务的高可用。
  - 可以将一个数据存储多个副本，实现可靠的备份。
- 难点：
  - 系统规模变大、结构变复杂，维护麻烦。
  - 同一个应用要运行多个实例，占用资源的冗余多。

## 共识

：Consensus ，指系统中不同节点作出的决策相同。
- 脑裂（brain split）
  - ：指一个系统中存在多个有权决策的节点，并且作出了不同决策。
- 拜占庭将军问题（Byzantine Generals Problem）
  - ：多个拜占庭将军自主观察敌情，然后通过投票决定进攻还是撤退。但可能存在不诚实的将军，或者投票信件被丢失、篡改。
  - 该问题代表系统中某些节点传播虚假的信息，导致其它节点作出了错误决策。

### Paxos

：一个共识算法，于 1990 年发布。
- 系统中一些节点担任 Proposer ，有权发出提议（Proposal）、投票。
  - 其它节点担任 Acceptor ，有权投票。
- 每个提议需要超过半数的节点投票同意，才能通过。
  - 这属于多数派（Majority）策略，允许低于半数的节点不可用。

### Raft

：一个共识算法，在 Paxos 算法的基础上作了改进。
- 系统中有且仅有一个节点担任 Leader ，有权发出提议（Proposal）、投票。
  - 其它节点担任 Follower ，有权投票。
- 每次准备修改集群数据时，Leader 会将该提议发送给所有 Follower ，等超过半数的节点同意并执行之后，才通过该提议，从而达成共识、数据一致性。
  - 超过半数，又称为达到法定成员数（Quorum）。
    - 当节点总数为 N 时，法定成员数为 `Quorum = N/2 + 1` ，其中 / 为整除运算符。
    - Quorum 必须超过半数。如果允许 Quorum 等于集群半数，甚至小于半数，则集群就可能同时存在不止一个 leader ，发生脑裂。
  - 并不会等到所有节点都同意，因此属于最终一致性。
  - 该共识是容错的，允许 Quorum 之外的节点不可用。
    - 增加节点总数可以提供系统可用性，但是会增加每次达成共识的耗时。
- Leader 定期发送心跳包给其它节点。如果心跳超时，则其它节点变为 Candidate 状态，选举一个节点担任新 Leader 。
- 每次选出 Leader ，就开始一个新任期，称为 Term 。
- 每个节点都信任其它节点发来的信息，因此不能实现拜占庭容错。

### Bully

：一个共识算法，与 Raft 算法相似。
- 如果 Leader 节点故障，则由 ID 最大的一个节点担任新 Leader 。

### Gossip

：一个广播消息的协议，常用于 P2P 服务。
- 每个节点定期散播一次消息，最多发送给 k 个节点。
  - 发送消息之后，不必确保对方接收。
  - 其它节点收到消息之后，会散播给除了源节点之外的其它节点。
- 消息被病毒式传播，能实现最终一致性。

### PoW

：工作量证明（Proof of Work），一个区块链的共识算法。
- 比特币采用基于哈希函数的 PoW 算法：
  - 系统以区块为单位写入数据，区块按链式结构排列。
  - 每个节点需要穷举猜测下一个区块的 nonce 随机数，第一个猜出来的节点有权打包该区块，写入新数据，然后广播。
  - 攻击者可以从历史的某个区块分叉，重新创建区块，生成一条新的区块链。
    - 如果新链的运算量超过原链，即超过全部节点运算量的 50% ，则创建新区块的速度更快。在一段时间之后，新链的长度会超过旧链，而最长的链会被所有节点承认。
    - 如果攻击成功，则可以篡改历史区块的内容，使得同一笔资金发生不同的交易，因此由称为双花攻击。
    - 哈希运算需要消耗大量 CPU 和时间成本，因此攻击的成本非常高。

### PoS

：权益证明（Proof of Stake），一个区块链的共识算法。
- 每个节点拥有的代币越多，则权益越大，有更大概率获得下一个区块的打包权。
- 与 PoW 相比，节省了运算成本。

## 一致性

：Consistency ，指系统中不同节点拥有的数据副本一致（通常还应该是最新的数据）。
- 数据库的 ACID 指的是事务的一致性，而分布式系统中主要研究数据的一致性。
- 通常，需要各节点先达成共识，才能实现数据一致性。
  - 不过数据不一致性时，各节点可能因为不同的数据副本而作出不同的决策，不容易达成共识。
- 常见的几种一致性情况：
  - 强一致性：每次写操作之后，要等所有节点都复制完新数据，才能开始下一次写操作，即同步复制。
  - 弱一致性：不等同步就开始下一次写操作，即异步复制。
  - 最终一致性：属于弱一致性，但保证在一定时间内复制数据到所有节点。比如在客户端读取之前实现一致。

## 可用性

：Availability ，指客户端发出请求时，能在正常时间内收到响应。该响应不能是错误的，但可以不是最新的数据。
- 如果服务的响应时间较长，甚至服务中断，则称为可用性低。
- 采用负载均衡、健康检查等方式可以实现服务的高可用性。

### 单点故障

：Single Point of Failure ，系统中单个模块或主机发生故障，导致整个系统的服务不可用。

### 健康检查

：Health Check ，通过软件检查集群中各个服务器的状态，自动发现故障的服务器。
- 发现故障节点之后，需要及时将它下线，或修复，或重新部署。

相关工具：
- keepalived ：一个命令行工具，用于对多个服务器进行健康检查、自动去除故障服务器。
  - 在集群的每个服务器上部署一份，相互之间通过 VRRP（Virtual Router Redundancy Protocol ，虚拟路由冗余协议）通信，实现路由的高可用。
  - 工作在第三层时，是基于 ICMP 协议检查服务器是否在线。
  - 工作在第四层时，是基于 TCP 协议检查服务器的端口是否开通。
  - 工作在第七层时，是基于 HTTP 协议检查服务器是否正常工作。

## 分区容错性

：Partition tolerance ，指系统出现网络分区时，能否继续提供服务。
- 如果任意两个节点之间不能在指定时间内将数据同步一致（比如网络延迟较大、节点故障），则视作网络中断，出现了网络分区。

## CAP 定理

：一个流行的理论，认为在分布式系统中，一致性（C）、可用性（A）、分区容错性（P） 三种性能通常不能同时满足，最多满足两种。
- 假设分布式系统中存在两个节点 N1、N2 ，两者的网络通信必然存在一定延迟。先在 N1 处写入数据 D ，然后在 N2 处读取数据 D 。此时：
  - 如果 N2 等同步 N1 的数据之后再返回响应，则满足了 C ，但不满足 A 。
  - 如果 N2 不同步 N1 的数据就返回响应，则必然是错误的响应，满足了 A ，但不满足 C 。
  - 如果 N1 或 N2 因为网络分区而不能提供服务，则满足了 C ，但不满足 A、P 。
