# 管理集群

- ES 采用分布式架构，既可以只部署单个节点，也可以扩展到包含几百个节点的集群，处理 PB 级别的数据。
- 一个 ES 集群（cluster）中的所有节点（node）都具有相同的集群名（cluster.name）。
  - ES 会选出一个节点担任主节点（master），负责管理集群，比如增删节点、增删索引，但不支持用户修改文档、查询文档，以减少流量压力。
  - 用户可以与任何节点通信，
  - 每个节点都知道各个文档存储在哪个节点上。因此用户可以向任意节点发出查询请求，该节点会将请求转发给存储相应文档的节点（可能有多个），然后将查询结果返回给用户。

## 分片

- ES 会给每个新增的索引划分几个分片（shard），该索引下新增的文档会平均分配到各个分片中，而所有分片会分散存储到各个节点中。
  - 分片是 ES 存储数据的最小单位。
  - 当集群扩容或缩容时，ES 会自动迁移分片，均衡地存储到各个节点。
  - 单个分片的存储容量理论上没有上限，但是存储的文档越多，会导致查询耗时越久。
  - 当用户查询某个文档时，ES 会先找到存储该文档的分片，然后读取该文档的内容，返回给用户。
- 分片分为两类：
  - 主分片（primary shard）
    - ：用于存储某个索引的数据。
    - 每个索引可以划分1个或多个主分片。
  - 复制分片（replica shard）
    - ：主分片的副本，只支持读请求，不支持写请求。
    - 每个主分片可以有0个或任意个复制分片。
- 在创建索引时可以设置其分片数量，如下：
  ```sh
  PUT /student
  {
    "settings" : {
        "number_of_shards" : 3,   # 给该索引划分3个主分片
        "number_of_replicas" : 1  # 给每个主分片创建1个复制分片
    }
  }
  ```
  - 这里只能使用 PUT 方法，并且创建了索引之后就不能再修改其分片数量。


## 相关 API

查看 ES 集群的状态：
```sh
[root@Centos ~]# curl -X GET 127.0.0.1:9200/_cluster/health?pretty
{
  "cluster_name" : "elasticsearch",
  "status" : "yellow",            # 集群的状态
  "timed_out" : false,
  "number_of_nodes" : 1,          # 节点的数量
  "number_of_data_nodes" : 1,     # 数据节点的数量
  "active_primary_shards" : 4,    # 主分片的数量
  "active_shards" : 4,            # 分片的数量
  "relocating_shards" : 0,
  "initializing_shards" : 0,
  "unassigned_shards" : 4,        # 未分配的分片的数量
  "delayed_unassigned_shards" : 0,
  "number_of_pending_tasks" : 0,
  "number_of_in_flight_fetch" : 0,
  "task_max_waiting_in_queue_millis" : 0,
  "active_shards_percent_as_number" : 50.0
}
```
- 集群的 `status` 可能取以下三种值：
  - `green` ：所有主要分片、复制分片都可用。
  - `yellow` ：所有主要分片都可用，但不是所有复制分片都可用。
  - `red` ：不是所有主要分片都可用。
- 复制分片不会被分配到主分片所在节点上，因为那样不能实现灾备。如果集群内没有其它节点了，复制分片就会一直处于未分配状态。

