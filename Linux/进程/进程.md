# 进程

进程：程序运行时的最小单位。

- 在终端启动一个程序时就会创建一个进程。
- 操作系统一般会提供创建进程的API。Linux是fork()，Windows是CreateThread()。
- Linux系统会给每个进程分配一个唯一的进程标识符（PID）。

## 进程分类

- 前台进程：绑定到当前终端的stdin，因此会阻塞当前终端。
  - 普通启动的进程默认会绑定到当前终端的stdin、stdout、stderr。
- 后台进程：没有绑定到终端的stdin，但可能绑定了stdout、stderr。
  - 前台进程、后台进程都是当前终端的子进程。如果用户关闭当前终端，系统就会给这些进程发送SIGNUP信号，终止它们。
- 守护进程（daemon）：特殊的后台进程。
  - 运行在一个独立的Session中，完全脱离用户的终端。不会受到SIGNUP信号。
  - 系统服务程序通常作为守护进程运行，从而保证能持续提供服务。

## 进程组

进程组（Process Group）：包含一个或多个具有父子关系的进程。
- 一个进程组中有且仅有一个Leader进程，是其它进程的根父进程，其PID就是该进程组的PGID。

## 会话

bash支持创建会话（Session），管理一个或多个具有父子关系的进程组。
- sh不支持创建会话。
- 一个Session中有且仅有一个Leader进程，是其它进程、进程组的根父进程，其PID就是该Session的SID。
- 会话中的进程组又称为job，用于完成某种任务。
- 当Session Leader终止时，系统会给该Session的所有进程发送SIGNUP信号来终止它们。当Session中的所有进程都终止时，该Session就宣告消失。

例：

    用户登录时会创建一个登录shell，还会创建一个Session，以登录shell作为Session Leader。
    在该Session中，只有一个进程组能工作在前台，其它进程组都只能工作在后台。
    当用户登出时，属于该Session的所有进程组都会被系统终止。

## 进程间通信

Linux系统上，进程间通信（Inter Process Communication，IPC）的主要方式如下：

- 管道（pipe）：进程创建一个管道文件，和另一个进程连接到它，从中读写数据。
  - 采用半双工通信，当一个进程写数据时，另一个进程只能读数据。
  - 匿名管道（PIPE）：保存在内存中，没有文件描述符，只能用于父子进程之间的通信。比如管道符 | 。
  - 命名管道（FIFO）：保存为文件系统中的一个文件，常用于两个独立进程之间的通信。
- 信号（signal）：内核发送一个信号给进程。
  - 信号相当于在软件层的模拟中断，可能来源于硬件（比如键盘信号），也可能来源于软件（比如用kill命令）。
  - 当进程收到信号时，可以捕捉信号并执行动作，也可以忽略信号。
- 信号量（semophore）：一个非负整数，记录某个资源的可用数量。为0时表示资源不可用。
- 套接字（socket）：有两种用法：
  - `Unix domain sockets`：用于本机的进程之间的通信，保存为一个套接字文件。比如/var/lib/mysql/mysql.sock。
  - `基于TCP/UDP协议的sockets`：用于不同主机之间的进程通信，用host:port确定一个套接字。
- 共享内存（shared memory）：一块内存空间，允许多个进程同时访问，读写速度很快。
  - 共享内存由内核创建，进程可以把它映射到自己的私有地址空间，从而访问它。
  - 当多个进程同时访问共享内存时，需要采取一些措施保证线程之间同步。
- 消息队列（message queue）：一个链表结构，允许多个进程从中读写数据。

## 进程的运行状态

- R：Running。
- S：Sleeping。进程被CPU挂起，等到某一时刻或满足某些条件时再继续运行。
- D：Disk Sleep。进程等待磁盘IO，此时处于不可中断状态。
- I：idle。即空闲状态，此时进程不会占用CPU。
- Z：Zombie。
  - 僵尸进程已经运行结束，但进程描述符还存在，说明父进程还没有回收它的资源。
  - 如果父进程没有正确回收子进程，还不断创建子进程，就会占用越来越多的系统资源。即使这些子进程自己运行结束了，变成僵尸进程，也可能耗尽系统的PID，导致系- 统不能创建新进程。
  - 如果父进程运行结束，init进程会自动回收它的所有子进程。
- T：stopped，暂停状态。
- t：traced，比如进程被断点调试时处于被跟踪状态。
- X：进程正在终止，这是一个短暂的状态。

## 进程的标志符

- s：该进程是Session Leader。
- +：该进程属于前台进程。
- <：high-priority (not nice to other users)。
- N：low-priority (nice to other users)。
- L：已锁定内存中的page。
- l：是多线程的（使用CLONE_THREAD）。
